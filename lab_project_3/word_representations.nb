(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Wolfram 14.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       154,          7]
NotebookDataLength[     16945,        422]
NotebookOptionsPosition[     16211,        404]
NotebookOutlinePosition[     16603,        420]
CellTagsIndexPosition[     16560,        417]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"enwik8", "=", 
    RowBox[{"Import", "[", 
     RowBox[{"\"\<Downloads/enwik8\>\"", ",", "\"\<Text\>\""}], "]"}]}], 
   ";"}], "\n", 
  RowBox[{"(*", " ", 
   RowBox[{"remove", " ", "HTML", " ", "and", " ", "XML", " ", "tags"}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"enwik8", "=", 
   RowBox[{"StringReplace", "[", 
    RowBox[{"enwik8", ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{"\"\<<\>\"", "~~", 
         RowBox[{"Shortest", "[", "___", "]"}], "~~", "\"\<>\>\""}], 
        "->", "\"\< \>\""}], ",", 
       RowBox[{
        RowBox[{"\"\<&\>\"", "~~", 
         RowBox[{"Shortest", "[", "___", "]"}], "~~", "\"\<;\>\""}], 
        "->", "\"\< \>\""}], ",", 
       RowBox[{
        RowBox[{"\"\<#\>\"", "~~", 
         RowBox[{"Shortest", "[", "___", "]"}], "~~", "\"\<;\>\""}], 
        "->", "\"\< \>\""}], ",", 
       RowBox[{
        RowBox[{"\"\<http\>\"", "~~", 
         RowBox[{"Shortest", "[", "___", "]"}], "~~", "\"\< \>\""}], 
        "->", "\"\< \>\""}]}], "}"}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"enwik8", "=", 
    RowBox[{"RemoveDiacritics", "[", "enwik8", "]"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "keep", " ", "only", " ", "alphanumeric", " ", "characters", " ", "and", " ",
     "spaces"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"enwik8", "=", 
    RowBox[{"StringReplace", "[", 
     RowBox[{"enwik8", ",", 
      RowBox[{
       RowBox[{
        RowBox[{"Except", "[", 
         RowBox[{"WordCharacter", "|", "WhitespaceCharacter"}], "]"}], ".."}],
        "->", "\"\<\>\""}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"lowercase", " ", "all", " ", "text"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"enwik8", "=", 
    RowBox[{"ToLowerCase", "[", "enwik8", "]"}]}], ";"}], "\n", 
  RowBox[{"(*", " ", 
   RowBox[{"list", " ", "of", " ", "words"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"words", "=", 
   RowBox[{"StringSplit", "[", "enwik8", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"wordCounts", "=", 
   RowBox[{"Counts", "[", "words", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"mostCommonWordsCounts", "=", 
   RowBox[{"TakeLargest", "[", 
    RowBox[{"wordCounts", ",", "10000"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"mostCommonWords", "=", 
   RowBox[{"Keys", "[", "mostCommonWordsCounts", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"wordSim", "=", 
   RowBox[{"ToLowerCase", "[", 
    RowBox[{"DeleteDuplicates", "[", 
     RowBox[{"Flatten", "[", 
      RowBox[{"Most", "/@", 
       RowBox[{"Rest", "[", 
        RowBox[{"Import", "[", "\"\<Downloads/wordsim353crowd.csv\>\"", "]"}],
         "]"}]}], "]"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"mostCommonWords", "=", 
   RowBox[{"Join", "[", 
    RowBox[{"mostCommonWords", ",", 
     RowBox[{"Complement", "[", 
      RowBox[{"wordSim", ",", "mostCommonWords"}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"wordIndex", "=", 
   RowBox[{"AssociationThread", "[", 
    RowBox[{"mostCommonWords", ",", 
     RowBox[{"Range", "[", 
      RowBox[{"Length", "[", "mostCommonWords", "]"}], "]"}]}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.975550473927864*^9, 3.975550488197124*^9}, {
   3.97555052164465*^9, 3.975550522090289*^9}, 3.975551418794465*^9, {
   3.97561646264939*^9, 3.97561652694037*^9}, {3.975617326257259*^9, 
   3.975617327693283*^9}, {3.9756174936310863`*^9, 3.975617502691616*^9}, {
   3.975622164933201*^9, 3.975622175414694*^9}, {3.97562235900661*^9, 
   3.975622359304734*^9}, {3.975623253169256*^9, 3.975623261247229*^9}, {
   3.9756262106264277`*^9, 3.975626239798129*^9}, 3.975626273729273*^9, {
   3.975626330315175*^9, 3.97562633857683*^9}, 3.9756279484791718`*^9, {
   3.975628284185932*^9, 3.975628288865267*^9}, 3.9756286415786858`*^9, {
   3.9756306454420156`*^9, 3.975630648730989*^9}, {3.975682199370062*^9, 
   3.975682203433428*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"8f669264-3c08-450f-a5fb-aae646d9419f"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"stream", "=", 
   RowBox[{"StringToStream", "[", "enwik8", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nCols", "=", 
   RowBox[{"Length", "[", "mostCommonWords", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"row", "=", "1"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"AbsoluteTiming", "[", 
  RowBox[{"Monitor", "[", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"rowInds", ",", "colInds", ",", "vals"}], "}"}], "=", 
      RowBox[{
       RowBox[{"Reap", "[", 
        RowBox[{
         RowBox[{"While", "[", 
          RowBox[{
           RowBox[{"StringQ", "[", 
            RowBox[{"line", "=", 
             RowBox[{"ReadLine", "[", "stream", "]"}]}], "]"}], ",", 
           RowBox[{
            RowBox[{"w", "=", 
             RowBox[{"StringSplit", "[", "line", "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Length", "[", "w", "]"}], "<=", "3"}], ",", 
              RowBox[{"Continue", "[", "]"}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"ids", "=", 
             RowBox[{"Lookup", "[", 
              RowBox[{"wordIndex", ",", "w", ",", "Nothing"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"cnts", "=", 
             RowBox[{"Tally", "[", "ids", "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"cols", "=", 
             RowBox[{"cnts", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "1"}], "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"cts", "=", 
             RowBox[{"cnts", "[", 
              RowBox[{"[", 
               RowBox[{"All", ",", "2"}], "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"Sow", "[", 
             RowBox[{
              RowBox[{"ConstantArray", "[", 
               RowBox[{"row", ",", 
                RowBox[{"Length", "[", "cols", "]"}]}], "]"}], 
              ",", "\"\<r\>\""}], "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"Sow", "[", 
             RowBox[{"cols", ",", "\"\<c\>\""}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"Sow", "[", 
             RowBox[{"cts", ",", "\"\<v\>\""}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"row", "++"}]}]}], "]"}], ",", "_", ",", 
         RowBox[{
          RowBox[{"Developer`ToPackedArray", "[", 
           RowBox[{"Flatten", "[", "#2", "]"}], "]"}], "&"}]}], "]"}], "[", 
       RowBox[{"[", "2", "]"}], "]"}]}], ";"}], ",", "row"}], "]"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Close", "[", "stream", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"documentWordFrequencyMatrix", "=", 
   RowBox[{"SparseArray", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Transpose", "[", 
       RowBox[{"{", 
        RowBox[{"rowInds", ",", "colInds"}], "}"}], "]"}], "->", "vals"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"row", "-", "1"}], ",", "nCols"}], "}"}]}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.9756173205286922`*^9, 3.9756173798055887`*^9}, {
   3.975617423530046*^9, 3.9756174238777514`*^9}, {3.97562222471964*^9, 
   3.975622232777742*^9}, {3.975622301087296*^9, 3.975622333895855*^9}, {
   3.975622671150518*^9, 3.975622683540803*^9}, {3.9756227222640457`*^9, 
   3.975622748190426*^9}, {3.975622800124812*^9, 3.9756228420035458`*^9}, {
   3.975622886879261*^9, 3.9756228880780582`*^9}, {3.975623319966469*^9, 
   3.975623352078518*^9}, {3.975623416554646*^9, 3.975623524550756*^9}, {
   3.975623559821661*^9, 3.975623560828168*^9}, 3.975623679526009*^9, {
   3.9756256795607643`*^9, 3.975625706136592*^9}, {3.975625737520687*^9, 
   3.975625740437512*^9}, {3.9756257845903788`*^9, 3.975625785068161*^9}, {
   3.975626347302702*^9, 3.975626350949389*^9}, {3.975626415461588*^9, 
   3.9756264235597754`*^9}, {3.975626623410928*^9, 3.9756266681144037`*^9}, {
   3.975626707924985*^9, 3.9756267531245203`*^9}, {3.975627042191821*^9, 
   3.975627042909544*^9}, {3.975627801569022*^9, 3.975627839453269*^9}, {
   3.975629020435258*^9, 3.9756290376848917`*^9}, {3.975629106767434*^9, 
   3.975629108307221*^9}, {3.975630296398089*^9, 3.9756302968029633`*^9}, 
   3.975669356532035*^9},
 CellLabel->"In[13]:=",ExpressionUUID->"eb28127b-def8-4679-b6f8-8dcd9f4c8c62"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"AbsoluteTiming", "[", 
    RowBox[{"MaxMemoryUsed", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Usvd", "[", "#", "]"}], ",", 
        RowBox[{"Ssvd", "[", "#", "]"}], ",", 
        RowBox[{"Vsvd", "[", "#", "]"}]}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", 
       RowBox[{
        RowBox[{"N", "[", "documentWordFrequencyMatrix", "]"}], ",", "#"}], 
       "]"}]}], "]"}], "]"}], "&"}], "/@", 
  RowBox[{"{", 
   RowBox[{"20", ",", "50", ",", "100"}], "}"}]}]], "Input",
 CellChangeTimes->{{3.97567241408259*^9, 3.975672468311034*^9}, {
  3.975672764101708*^9, 3.9756727656342487`*^9}, {3.975761962855474*^9, 
  3.975761974731266*^9}, {3.9757624287498198`*^9, 3.975762460943782*^9}},
 CellLabel->"In[19]:=",ExpressionUUID->"a8ba9b95-60b3-46d0-b0d1-b7de8fb4061e"],

Cell[BoxData[
 RowBox[{
  RowBox[{"matrixFactorization", "[", 
   RowBox[{"mat_", ",", "k_", ",", "l1_", ",", "l2_", ",", "steps_"}], "]"}], 
  ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "m", ",", "n", ",", "A", ",", "B", ",", "U", ",", "V", ",", "u", ",", 
      "v"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"n", ",", "m"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "mat", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"v", "[", "j", "]"}], "=", 
        RowBox[{"RandomReal", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", "k"}], "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "m"}], "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"A", "=", 
         RowBox[{"Inverse", "[", 
          RowBox[{
           RowBox[{"Sum", "[", 
            RowBox[{
             RowBox[{"Outer", "[", 
              RowBox[{"Times", ",", 
               RowBox[{"v", "[", "j", "]"}], ",", 
               RowBox[{"v", "[", "j", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "m"}], "}"}]}], "]"}], "+", 
           RowBox[{"l1", " ", 
            RowBox[{"IdentityMatrix", "[", "k", "]"}]}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"V", "=", 
         RowBox[{"Array", "[", 
          RowBox[{"v", ",", "m"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"U", "=", 
         RowBox[{"V", ".", 
          RowBox[{"Transpose", "[", "A", "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"U", "=", 
         RowBox[{"mat", ".", "U"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Do", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"u", "[", "i", "]"}], "=", 
           RowBox[{"U", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "n"}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"B", "=", 
         RowBox[{"Inverse", "[", 
          RowBox[{
           RowBox[{"Sum", "[", 
            RowBox[{
             RowBox[{"Outer", "[", 
              RowBox[{"Times", ",", 
               RowBox[{"u", "[", "i", "]"}], ",", 
               RowBox[{"u", "[", "i", "]"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "n"}], "}"}]}], "]"}], "+", 
           RowBox[{"l2", " ", 
            RowBox[{"IdentityMatrix", "[", "k", "]"}]}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"U", "=", 
         RowBox[{"Array", "[", 
          RowBox[{"u", ",", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"V", "=", 
         RowBox[{"B", ".", 
          RowBox[{"Transpose", "[", "U", "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"V", "=", 
         RowBox[{"V", ".", "mat"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"V", "=", 
         RowBox[{"Transpose", "[", "V", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Do", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"v", "[", "j", "]"}], "=", 
           RowBox[{"V", "[", 
            RowBox[{"[", "j", "]"}], "]"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", "m"}], "}"}]}], "]"}]}], ",", "steps"}], "]"}], ";",
      "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{"U", ",", "V"}], "}"}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.975762115429825*^9, 3.9757622786395283`*^9}, {
   3.9757623614528427`*^9, 3.975762363408266*^9}, 3.975762408322328*^9},
 CellLabel->"In[20]:=",ExpressionUUID->"50bd10f2-a885-4ac9-be3c-6f2e46528b06"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"AbsoluteTiming", "[", 
    RowBox[{"MaxMemoryUsed", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Ualt", "[", "#", "]"}], ",", 
        RowBox[{"Valt", "[", "#", "]"}]}], "}"}], "=", 
      RowBox[{"matrixFactorization", "[", 
       RowBox[{
       "documentWordFrequencyMatrix", ",", "#", ",", "1", ",", "1", ",", 
        "10"}], "]"}]}], "]"}], "]"}], "&"}], "/@", 
  RowBox[{"{", 
   RowBox[{"20", ",", "50", ",", "100"}], "}"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Norm", "[", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Ualt", "[", "#", "]"}], ".", 
         RowBox[{"Transpose", "[", 
          RowBox[{"Valt", "[", "#", "]"}], "]"}]}], "-", 
        "documentWordFrequencyMatrix"}], "]"}], "]"}], ",", 
     RowBox[{"Norm", "[", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Usvd", "[", "#", "]"}], ".", 
         RowBox[{"Ssvd", "[", "#", "]"}], ".", 
         RowBox[{"Transpose", "[", 
          RowBox[{"Vsvd", "[", "#", "]"}], "]"}]}], "-", 
        "documentWordFrequencyMatrix"}], "]"}], "]"}]}], "}"}], "&"}], "/@", 
  RowBox[{"{", 
   RowBox[{"20", ",", "50", ",", "100"}], "}"}]}]}], "Input",
 CellChangeTimes->{{3.9757587614141912`*^9, 3.97575877827649*^9}, {
   3.975759625989463*^9, 3.975759635488669*^9}, {3.975759691228899*^9, 
   3.9757597364185467`*^9}, {3.97575977941605*^9, 3.975759806624948*^9}, {
   3.975759884579198*^9, 3.9757598962400923`*^9}, {3.9757599910256042`*^9, 
   3.975759995936915*^9}, {3.975760635189496*^9, 3.975760644044221*^9}, {
   3.975760677724807*^9, 3.975760681345155*^9}, {3.975760715747019*^9, 
   3.975760817598095*^9}, {3.9757614539443493`*^9, 3.975761508796176*^9}, {
   3.975761598955551*^9, 3.9757615991024837`*^9}, {3.975761679036006*^9, 
   3.975761704618061*^9}, {3.975761755879871*^9, 3.975761771084146*^9}, {
   3.975762349094338*^9, 3.975762375519508*^9}, {3.97576244056246*^9, 
   3.9757625833765287`*^9}, {3.975763256192398*^9, 3.975763259305481*^9}, {
   3.975763393965911*^9, 3.975763406137808*^9}, 3.975763518361676*^9},
 CellLabel->"In[21]:=",ExpressionUUID->"0d7e3867-4870-4165-a4d9-b186751769ff"]
},
WindowSize->{1728, 1051},
WindowMargins->{{0, Automatic}, {Automatic, 0}},
FrontEndVersion->"14.3 for Mac OS X ARM (64-bit) (July 8, 2025)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"cfc9626b-a424-449c-a98d-995028b8d6fd"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[554, 20, 4256, 105, 335, "Input",ExpressionUUID->"8f669264-3c08-450f-a5fb-aae646d9419f"],
Cell[4813, 127, 4435, 98, 315, "Input",ExpressionUUID->"eb28127b-def8-4679-b6f8-8dcd9f4c8c62"],
Cell[9251, 227, 860, 20, 29, "Input",ExpressionUUID->"a8ba9b95-60b3-46d0-b0d1-b7de8fb4061e"],
Cell[10114, 249, 3815, 100, 315, "Input",ExpressionUUID->"50bd10f2-a885-4ac9-be3c-6f2e46528b06"],
Cell[13932, 351, 2275, 51, 49, "Input",ExpressionUUID->"0d7e3867-4870-4165-a4d9-b186751769ff"]
}
]
*)

