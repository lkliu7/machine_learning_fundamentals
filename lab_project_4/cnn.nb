(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Wolfram 14.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       154,          7]
NotebookDataLength[     33045,        938]
NotebookOptionsPosition[     32307,        920]
NotebookOutlinePosition[     32699,        936]
CellTagsIndexPosition[     32656,        933]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{"mnist", "=", 
   RowBox[{"ResourceData", "[", 
    RowBox[{"\"\<MNIST\>\"", ",", "\"\<TrainingData\>\""}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"mnistTest", "=", 
   RowBox[{"ResourceData", "[", 
    RowBox[{"\"\<MNIST\>\"", ",", "\"\<TestData\>\""}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"group", "[", "i_", "]"}], ":=", 
  RowBox[{
   RowBox[{"group", "[", "i", "]"}], "=", 
   RowBox[{
    RowBox[{"Select", "[", 
     RowBox[{"mnist", ",", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "==", "i"}], "&"}]}], "]"}], "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"trainSize", "[", "i_", "]"}], ":=", 
  RowBox[{
   RowBox[{"trainSize", "[", "i", "]"}], "=", 
   RowBox[{"Length", "[", 
    RowBox[{"group", "[", "i", "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"groupTest", "[", "i_", "]"}], ":=", 
  RowBox[{
   RowBox[{"groupTest", "[", "i", "]"}], "=", 
   RowBox[{
    RowBox[{"Select", "[", 
     RowBox[{"mnistTest", ",", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "==", "i"}], "&"}]}], "]"}], "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testSize", "[", "i_", "]"}], ":=", 
  RowBox[{
   RowBox[{"testSize", "[", "i", "]"}], "=", 
   RowBox[{"Length", "[", 
    RowBox[{"groupTest", "[", "i", "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"vec", "[", "img_", "]"}], ":=", 
  RowBox[{"1", "-", 
   RowBox[{"Flatten", "[", 
    RowBox[{"ImageData", "[", "img", "]"}], 
    "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"mat", "[", "img_", "]"}], ":=", 
  RowBox[{"1", "-", 
   RowBox[{"ImageData", "[", "img", "]"}]}]}]}], "Input",
 CellChangeTimes->{{3.9750268793331203`*^9, 3.9750269215800047`*^9}, 
   3.976100003828727*^9, {3.976100034640066*^9, 3.976100060391409*^9}, 
   3.976100661069633*^9, {3.9762038833538027`*^9, 3.976203888807516*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"12b745ba-6c5a-4023-8ad9-9da76874d8e2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"data", "=", 
   RowBox[{"mat", "/@", 
    RowBox[{"mnist", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"labels", "=", 
   RowBox[{"mnist", "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "2"}], "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testData", "=", 
   RowBox[{"mat", "/@", 
    RowBox[{"mnistTest", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testLabels", "=", 
   RowBox[{"mnistTest", "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "2"}], "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nTrain", "=", 
   RowBox[{"Length", "[", "labels", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nTest", "=", 
   RowBox[{"Length", "[", "testLabels", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"classes", "=", 
   RowBox[{"DeleteDuplicates", "[", "labels", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nClasses", "=", 
   RowBox[{"Length", "[", "classes", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"AssociationThread", "[", 
    RowBox[{"classes", "->", 
     RowBox[{"Range", "[", "nClasses", "]"}]}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.976100598959671*^9, 3.976100620354196*^9}, {
   3.976100950457341*^9, 3.976100956921783*^9}, {3.976101075995407*^9, 
   3.976101109167481*^9}, {3.9761013662430887`*^9, 3.97610140233617*^9}, {
   3.9761056183741293`*^9, 3.97610562880655*^9}, {3.976105662871686*^9, 
   3.976105670539914*^9}, 3.976123547629385*^9, {3.976229591247658*^9, 
   3.9762296109448767`*^9}, {3.9762296433188877`*^9, 3.976229662995109*^9}},
 CellLabel->"In[9]:=",ExpressionUUID->"13662720-b09d-43cb-a136-01a86310efc1"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"addRightColumn", "[", "matrix_", "]"}], ":=", 
  RowBox[{
   RowBox[{"Append", "[", "0.", "]"}], "/@", "matrix"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"addRightColumn", "[", 
   RowBox[{"matrix_", ",", "k_"}], "]"}], ":=", 
  RowBox[{"Nest", "[", 
   RowBox[{"addRightColumn", ",", "matrix", ",", "k"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"addLeftColumn", "[", "matrix_", "]"}], ":=", 
  RowBox[{
   RowBox[{"Prepend", "[", "0.", "]"}], "/@", "matrix"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"addLeftColumn", "[", 
   RowBox[{"matrix_", ",", "k_"}], "]"}], ":=", 
  RowBox[{"Nest", "[", 
   RowBox[{"addLeftColumn", ",", "matrix", ",", "k"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"addTopRow", "[", "matrix_", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"m", ",", "n"}], "}"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"m", ",", "n"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "matrix", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Prepend", "[", 
      RowBox[{"matrix", ",", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{"0.", ",", "n"}], "]"}]}], "]"}]}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"addTopRow", "[", 
   RowBox[{"matrix_", ",", "k_"}], "]"}], ":=", 
  RowBox[{"Nest", "[", 
   RowBox[{"addTopRow", ",", "matrix", ",", "k"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"addBottomRow", "[", "matrix_", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"m", ",", "n"}], "}"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"m", ",", "n"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "matrix", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Append", "[", 
      RowBox[{"matrix", ",", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{"0.", ",", "n"}], "]"}]}], "]"}]}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"addBottomRow", "[", 
   RowBox[{"matrix_", ",", "k_"}], "]"}], ":=", 
  RowBox[{"Nest", "[", 
   RowBox[{"addBottomRow", ",", "matrix", ",", "k"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"convolutionProduct", "[", 
   RowBox[{"matrix_", ",", "kernel_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"k", ",", "l", ",", "m", ",", "n", ",", "newMatrix"}], "}"}], ",",
     "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"k", ",", "l"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "matrix", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"m", ",", "n"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "kernel", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"newMatrix", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"0.", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"k", "-", "m", "+", "1"}], ",", 
          RowBox[{"l", "-", "n", "+", "1"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{"newMatrix", "+=", 
        RowBox[{
         RowBox[{"kernel", "[", 
          RowBox[{"[", 
           RowBox[{"i", ",", "j"}], "]"}], "]"}], 
         RowBox[{"matrix", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"i", ";;", 
             RowBox[{"k", "-", "m", "+", "i"}]}], ",", 
            RowBox[{"j", ";;", 
             RowBox[{"l", "-", "n", "+", "j"}]}]}], "]"}], "]"}]}]}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "m"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "n"}], "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
     "newMatrix"}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"correlationProduct", "[", 
   RowBox[{"matrix_", ",", "kernel_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"k", ",", "l", ",", "m", ",", "n", ",", "newMatrix"}], "}"}], ",",
     "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"k", ",", "l"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "matrix", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"m", ",", "n"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "kernel", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"newMatrix", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"0.", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"k", "-", "m", "+", "1"}], ",", 
          RowBox[{"l", "-", "n", "+", "1"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{"newMatrix", "+=", 
        RowBox[{
         RowBox[{"kernel", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"m", "-", "i", "+", "1"}], ",", 
            RowBox[{"n", "-", "j", "+", "1"}]}], "]"}], "]"}], 
         RowBox[{"matrix", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"i", ";;", 
             RowBox[{"k", "-", "m", "+", "i"}]}], ",", 
            RowBox[{"j", ";;", 
             RowBox[{"l", "-", "n", "+", "j"}]}]}], "]"}], "]"}]}]}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "m"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "n"}], "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
     "newMatrix"}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"convolutionProduct2", "[", 
   RowBox[{"matrix_", ",", "kernel_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"k", ",", "l", ",", "m", ",", "n"}], "}"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"k", ",", "l"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "matrix", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"m", ",", "n"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "kernel", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"Total", "[", 
        RowBox[{
         RowBox[{"kernel", " ", 
          RowBox[{"matrix", "[", 
           RowBox[{"[", 
            RowBox[{
             RowBox[{"i", ";;", 
              RowBox[{"i", "+", "m", "-", "1"}]}], ",", 
             RowBox[{"j", ";;", 
              RowBox[{"j", "+", "n", "-", "1"}]}]}], "]"}], "]"}]}], ",", 
         "2"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"k", "-", "m", "+", "1"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", 
         RowBox[{"l", "-", "n", "+", "1"}]}], "}"}]}], "]"}]}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"maxpool", "[", 
   RowBox[{"array_", ",", "spec_"}], "]"}], ":=", 
  RowBox[{"Map", "[", 
   RowBox[{"Max", ",", 
    RowBox[{"Partition", "[", 
     RowBox[{"array", ",", 
      RowBox[{"UpTo", "/@", 
       RowBox[{"Flatten", "[", 
        RowBox[{"{", "spec", "}"}], "]"}]}]}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"Max", "[", 
      RowBox[{
       RowBox[{"Length", "[", "spec", "]"}], ",", "1"}], "]"}], "}"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"maxpoolD", "[", 
   RowBox[{"array_", ",", "spec_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"pooled", "=", 
       RowBox[{"maxpool", "[", 
        RowBox[{"array", ",", "spec"}], "]"}]}], ",", "empty"}], "}"}], ",", 
    RowBox[{"ArrayFlatten", "[", 
     RowBox[{
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"dims", "=", 
            RowBox[{"Dimensions", "[", "#1", "]"}]}], ";", 
           RowBox[{"fp", "=", 
            RowBox[{"FirstPosition", "[", 
             RowBox[{"#1", ",", "#2"}], "]"}]}], ";", 
           RowBox[{"empty", "=", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"0", ",", "dims"}], "]"}]}], ";", 
           RowBox[{
            RowBox[{"empty", "[", 
             RowBox[{"[", 
              RowBox[{"Sequence", "@@", "fp"}], "]"}], "]"}], "=", "1"}], ";",
            "empty"}], ")"}], "&"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"array", ",", 
            RowBox[{"UpTo", "/@", 
             RowBox[{"Flatten", "[", 
              RowBox[{"{", "spec", "}"}], "]"}]}]}], "]"}], ",", "pooled"}], 
         "}"}], ",", 
        RowBox[{"Max", "[", 
         RowBox[{
          RowBox[{"Length", "[", "spec", "]"}], ",", "1"}], "]"}]}], "]"}], ",", 
      RowBox[{"Max", "[", 
       RowBox[{
        RowBox[{"Length", "[", "spec", "]"}], ",", "1"}], "]"}]}], "]"}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.976221315309025*^9, 3.976221344504764*^9}, 
   3.9762214350141487`*^9, {3.976225065856852*^9, 3.976225066041827*^9}, {
   3.9762250983322163`*^9, 3.976225116553341*^9}, {3.97622853211406*^9, 
   3.976228539599065*^9}, {3.976228681096571*^9, 3.97622868249146*^9}, {
   3.976229272208712*^9, 3.976229275436349*^9}, {3.9762338804869328`*^9, 
   3.976233954790728*^9}, {3.976234205389256*^9, 3.976234224856764*^9}, 
   3.976234270891054*^9, {3.9762343206183043`*^9, 3.976234321010861*^9}, {
   3.9762410814610662`*^9, 3.976241084049829*^9}, {3.9762450128353167`*^9, 
   3.97624516967654*^9}, {3.976245262963437*^9, 3.9762452703252077`*^9}, {
   3.976245679465605*^9, 3.976245700193479*^9}},
 CellLabel->"In[18]:=",ExpressionUUID->"fca58653-f31e-4634-847c-0491020d8cbf"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "1", "]"}], "=", 
   RowBox[{"RandomVariate", "[", 
    RowBox[{
     RowBox[{"NormalDistribution", "[", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"32", ",", "3", ",", "3"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "2", "]"}], "=", 
   RowBox[{"RandomVariate", "[", 
    RowBox[{
     RowBox[{"NormalDistribution", "[", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"64", ",", "32", ",", "3", ",", "3"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "3", "]"}], "=", 
   RowBox[{"RandomVariate", "[", 
    RowBox[{
     RowBox[{"NormalDistribution", "[", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"64", ",", "64", ",", "3", ",", "3"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "5", "]"}], "=", 
   RowBox[{"RandomVariate", "[", 
    RowBox[{
     RowBox[{"NormalDistribution", "[", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"7744", ",", "7744"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"b", "[", "5", "]"}], "=", 
   RowBox[{"RandomVariate", "[", 
    RowBox[{
     RowBox[{"NormalDistribution", "[", "]"}], ",", "7744"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "6", "]"}], "=", 
   RowBox[{"RandomVariate", "[", 
    RowBox[{
     RowBox[{"NormalDistribution", "[", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"128", ",", "7744"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"b", "[", "6", "]"}], "=", 
   RowBox[{"RandomVariate", "[", 
    RowBox[{
     RowBox[{"NormalDistribution", "[", "]"}], ",", "128"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "7", "]"}], "=", 
   RowBox[{"RandomVariate", "[", 
    RowBox[{
     RowBox[{"NormalDistribution", "[", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"10", ",", "128"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"b", "[", "7", "]"}], "=", 
   RowBox[{"RandomVariate", "[", 
    RowBox[{
     RowBox[{"NormalDistribution", "[", "]"}], ",", "10"}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.976223638554644*^9, 3.976223678123293*^9}, {
  3.976223712664399*^9, 3.976223728568542*^9}, {3.9762239590497923`*^9, 
  3.9762239749515343`*^9}, {3.976224007762219*^9, 3.976224007802857*^9}, {
  3.9762242875780907`*^9, 3.976224304767605*^9}, {3.976224470455221*^9, 
  3.976224488019503*^9}, {3.9762252774997797`*^9, 3.976225284458849*^9}, {
  3.976225324662086*^9, 3.9762253560197573`*^9}, {3.976225388829075*^9, 
  3.976225409335413*^9}, {3.9762254436809053`*^9, 3.976225508850383*^9}, {
  3.9762264727792664`*^9, 3.976226539659336*^9}, {3.976226583583222*^9, 
  3.976226587389333*^9}, {3.976226648066868*^9, 3.976226656845935*^9}, {
  3.9762303277327013`*^9, 3.976230344186852*^9}},
 CellLabel->"In[31]:=",ExpressionUUID->"f100b477-6109-4002-8014-50ed825e8e06"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"start", "=", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"i", "=", "1"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "0", "]"}], "=", 
   RowBox[{"data", "[", 
    RowBox[{"[", "i", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"label", "=", 
   RowBox[{"pos", "[", 
    RowBox[{"labels", "[", 
     RowBox[{"[", "i", "]"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<setup \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "1", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"convolutionProduct", "[", 
      RowBox[{
       RowBox[{"Z", "[", "0", "]"}], ",", 
       RowBox[{
        RowBox[{"W", "[", "1", "]"}], "[", 
        RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "32"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "1", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "1", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<1 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "2", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Total", "[", 
      RowBox[{"MapThread", "[", 
       RowBox[{"convolutionProduct", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Z", "[", "1", "]"}], ",", 
          RowBox[{
           RowBox[{"W", "[", "2", "]"}], "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], "}"}]}], "]"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "64"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "2", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "2", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<2 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "3", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Total", "[", 
      RowBox[{"MapThread", "[", 
       RowBox[{"convolutionProduct", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Z", "[", "2", "]"}], ",", 
          RowBox[{
           RowBox[{"W", "[", "3", "]"}], "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], "}"}]}], "]"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "64"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "3", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "3", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<3 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "4", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"maxpool", "[", 
      RowBox[{"#", ",", 
       RowBox[{"{", 
        RowBox[{"2", ",", "2"}], "}"}]}], "]"}], "&"}], "/@", 
    RowBox[{"Z", "[", "3", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "4", "]"}], "=", 
   RowBox[{"Flatten", "[", 
    RowBox[{"A", "[", "4", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<4 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "5", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"W", "[", "5", "]"}], ".", 
     RowBox[{"Z", "[", "4", "]"}]}], "+", 
    RowBox[{"b", "[", "5", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "5", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "5", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<5 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "6", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"W", "[", "6", "]"}], ".", 
     RowBox[{"Z", "[", "5", "]"}]}], "+", 
    RowBox[{"b", "[", "6", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "6", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "6", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<6 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "7", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"W", "[", "7", "]"}], ".", 
     RowBox[{"Z", "[", "6", "]"}]}], "+", 
    RowBox[{"b", "[", "7", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"y", "=", 
   RowBox[{"Exp", "[", 
    RowBox[{"A", "[", "7", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"y", "=", 
   RowBox[{"y", "/", 
    RowBox[{"Total", "[", "y", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<pred \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"labelVec", "=", 
   RowBox[{"UnitVector", "[", 
    RowBox[{"nClasses", ",", "label"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"e", "[", "7", "]"}], "=", 
   RowBox[{"y", "-", "labelVec"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b7 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"e", "[", "j", "]"}], "=", 
     RowBox[{
      RowBox[{
       RowBox[{"e", "[", 
        RowBox[{"j", "+", "1"}], "]"}], ".", 
       RowBox[{"W", "[", 
        RowBox[{"j", "+", "1"}], "]"}]}], 
      RowBox[{"Transpose", "[", 
       RowBox[{"Unitize", "[", 
        RowBox[{"Z", "[", "j", "]"}], "]"}], "]"}]}]}], ",", 
    RowBox[{"{", 
     RowBox[{"j", ",", "6", ",", "4", ",", 
      RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b654 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"e", "[", "3", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"ArrayFlatten", "[", 
      RowBox[{
       RowBox[{"Partition", "[", 
        RowBox[{
         RowBox[{"maxpoolD", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Z", "[", "3", "]"}], "[", 
            RowBox[{"[", "j", "]"}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "2"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"2", ",", "2"}], "}"}]}], "]"}], 
       RowBox[{
        RowBox[{"Partition", "[", 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{
            RowBox[{"e", "[", "4", "]"}], ",", "11"}], "]"}], ",", "11"}], 
         "]"}], "[", 
        RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "64"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b3 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"e", "[", "2", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Sum", "[", 
      RowBox[{
       RowBox[{"convolutionProduct", "[", 
        RowBox[{
         RowBox[{"ArrayPad", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"e", "[", "3", "]"}], "[", 
            RowBox[{"[", "j", "]"}], "]"}], ",", "2"}], "]"}], ",", 
         RowBox[{"Reverse", "/@", 
          RowBox[{"Reverse", "[", 
           RowBox[{
            RowBox[{"W", "[", "3", "]"}], "[", 
            RowBox[{"[", 
             RowBox[{"j", ",", "i"}], "]"}], "]"}], "]"}]}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "64"}], "}"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "64"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b2 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"e", "[", "1", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Sum", "[", 
      RowBox[{
       RowBox[{"convolutionProduct", "[", 
        RowBox[{
         RowBox[{"ArrayPad", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"e", "[", "2", "]"}], "[", 
            RowBox[{"[", "j", "]"}], "]"}], ",", "2"}], "]"}], ",", 
         RowBox[{"Reverse", "/@", 
          RowBox[{"Reverse", "[", 
           RowBox[{
            RowBox[{"W", "[", "2", "]"}], "[", 
            RowBox[{"[", 
             RowBox[{"j", ",", "i"}], "]"}], "]"}], "]"}]}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "64"}], "}"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "32"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b1 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Do", "[", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"gradQW", "[", "j", "]"}], "=", 
     RowBox[{"KroneckerProduct", "[", 
      RowBox[{
       RowBox[{"e", "[", "j", "]"}], ",", 
       RowBox[{"Z", "[", 
        RowBox[{"j", "-", "1"}], "]"}]}], "]"}]}], ";", 
    RowBox[{
     RowBox[{"gradQb", "[", "j", "]"}], "=", 
     RowBox[{"e", "[", "j", "]"}]}]}], ",", 
   RowBox[{"{", 
    RowBox[{"j", ",", "5", ",", "7"}], "}"}]}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<w567 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"gradQW", "[", "3", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"convolutionProduct2", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Z", "[", "2", "]"}], "[", 
        RowBox[{"[", "i", "]"}], "]"}], ",", 
       RowBox[{
        RowBox[{"e", "[", "3", "]"}], "[", 
        RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "64"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "64"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<w3 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"gradQW", "[", "2", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"convolutionProduct2", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Z", "[", "1", "]"}], "[", 
        RowBox[{"[", "i", "]"}], "]"}], ",", 
       RowBox[{
        RowBox[{"e", "[", "2", "]"}], "[", 
        RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "64"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "32"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<w2 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"gradQW", "[", "1", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"convolutionProduct2", "[", 
      RowBox[{
       RowBox[{"Z", "[", "0", "]"}], ",", 
       RowBox[{
        RowBox[{"e", "[", "1", "]"}], "[", 
        RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "32"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<w1 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<end \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<total \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "start"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.976231061055578*^9, 3.97623108285287*^9}, {
  3.97623220302883*^9, 3.976232209464281*^9}, {3.976237320041429*^9, 
  3.976237349017597*^9}, {3.9762395995500107`*^9, 3.976239623594549*^9}, {
  3.9762396653753757`*^9, 3.976239862842849*^9}, {3.976241401200964*^9, 
  3.9762414328846684`*^9}, {3.976241494639925*^9, 3.97624149599325*^9}, {
  3.976241616063921*^9, 3.9762416281120987`*^9}, {3.976241728387857*^9, 
  3.976241728526182*^9}, {3.976241760595976*^9, 3.97624176597969*^9}, {
  3.97624191199116*^9, 3.9762420016571198`*^9}, {3.976242380846653*^9, 
  3.976242396501152*^9}, {3.976243090097048*^9, 3.976243094674457*^9}, {
  3.976245373873269*^9, 3.976245390938095*^9}, {3.976245464027341*^9, 
  3.9762454665298243`*^9}, {3.976245521932541*^9, 3.976245523581923*^9}, {
  3.976246708087772*^9, 3.976246714123077*^9}},
 CellLabel->
  "In[300]:=",ExpressionUUID->"bc4ea02f-0e78-40c9-a68d-629be0fa859d"]
},
WindowSize->{1728, 1051},
WindowMargins->{{0, Automatic}, {Automatic, 0}},
FrontEndVersion->"14.3 for Mac OS X ARM (64-bit) (July 8, 2025)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"0543f059-a012-4b6c-8655-c9482b1d85bf"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[554, 20, 2200, 61, 172, "Input",ExpressionUUID->"12b745ba-6c5a-4023-8ad9-9da76874d8e2"],
Cell[2757, 83, 1883, 48, 192, "Input",ExpressionUUID->"13662720-b09d-43cb-a136-01a86310efc1"],
Cell[4643, 133, 9559, 262, 642, "Input",ExpressionUUID->"fca58653-f31e-4634-847c-0491020d8cbf"],
Cell[14205, 397, 3046, 81, 192, "Input",ExpressionUUID->"f100b477-6109-4002-8014-50ed825e8e06"],
Cell[17254, 480, 15049, 438, 1336, "Input",ExpressionUUID->"bc4ea02f-0e78-40c9-a68d-629be0fa859d"]
}
]
*)

