(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Wolfram 14.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       154,          7]
NotebookDataLength[     87387,       2267]
NotebookOptionsPosition[     86257,       2245]
NotebookOutlinePosition[     86648,       2261]
CellTagsIndexPosition[     86605,       2258]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{"mnist", "=", 
   RowBox[{"ResourceData", "[", 
    RowBox[{"\"\<MNIST\>\"", ",", "\"\<TrainingData\>\""}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"mnistTest", "=", 
   RowBox[{"ResourceData", "[", 
    RowBox[{"\"\<MNIST\>\"", ",", "\"\<TestData\>\""}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"group", "[", "i_", "]"}], ":=", 
  RowBox[{
   RowBox[{"group", "[", "i", "]"}], "=", 
   RowBox[{
    RowBox[{"Select", "[", 
     RowBox[{"mnist", ",", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "==", "i"}], "&"}]}], "]"}], "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"trainSize", "[", "i_", "]"}], ":=", 
  RowBox[{
   RowBox[{"trainSize", "[", "i", "]"}], "=", 
   RowBox[{"Length", "[", 
    RowBox[{"group", "[", "i", "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"groupTest", "[", "i_", "]"}], ":=", 
  RowBox[{
   RowBox[{"groupTest", "[", "i", "]"}], "=", 
   RowBox[{
    RowBox[{"Select", "[", 
     RowBox[{"mnistTest", ",", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "==", "i"}], "&"}]}], "]"}], "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testSize", "[", "i_", "]"}], ":=", 
  RowBox[{
   RowBox[{"testSize", "[", "i", "]"}], "=", 
   RowBox[{"Length", "[", 
    RowBox[{"groupTest", "[", "i", "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"mat", "[", "img_", "]"}], ":=", 
  RowBox[{"1", "-", 
   RowBox[{"ImageData", "[", "img", "]"}]}]}]}], "Input",
 CellChangeTimes->{{3.9750268793331203`*^9, 3.9750269215800047`*^9}, 
   3.976100003828727*^9, {3.976100034640066*^9, 3.976100060391409*^9}, 
   3.976100661069633*^9, {3.9762038833538027`*^9, 3.976203888807516*^9}, 
   3.9764547658846493`*^9},
 CellLabel->
  "In[202]:=",ExpressionUUID->"3792c392-85da-43c8-ac61-496cc33e45cb"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"data", "=", 
   RowBox[{"Developer`ToPackedArray", "[", 
    RowBox[{"mat", "/@", 
     RowBox[{"mnist", "[", 
      RowBox[{"[", 
       RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"labels", "=", 
   RowBox[{"mnist", "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "2"}], "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testData", "=", 
   RowBox[{"Developer`ToPackedArray", "[", 
    RowBox[{"mat", "/@", 
     RowBox[{"mnistTest", "[", 
      RowBox[{"[", 
       RowBox[{"All", ",", "1"}], "]"}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testLabels", "=", 
   RowBox[{"mnistTest", "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "2"}], "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nTrain", "=", 
   RowBox[{"Length", "[", "labels", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nTest", "=", 
   RowBox[{"Length", "[", "testLabels", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"classes", "=", 
   RowBox[{"DeleteDuplicates", "[", "labels", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nClasses", "=", 
   RowBox[{"Length", "[", "classes", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"AssociationThread", "[", 
    RowBox[{"classes", "->", 
     RowBox[{"Range", "[", "nClasses", "]"}]}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.976100598959671*^9, 3.976100620354196*^9}, {
   3.976100950457341*^9, 3.976100956921783*^9}, {3.976101075995407*^9, 
   3.976101109167481*^9}, {3.9761013662430887`*^9, 3.97610140233617*^9}, {
   3.9761056183741293`*^9, 3.97610562880655*^9}, {3.976105662871686*^9, 
   3.976105670539914*^9}, 3.976123547629385*^9, {3.976229591247658*^9, 
   3.9762296109448767`*^9}, {3.9762296433188877`*^9, 3.976229662995109*^9}, {
   3.9764123760254908`*^9, 3.976412386042411*^9}},
 CellLabel->
  "In[209]:=",ExpressionUUID->"d0e49f47-63b3-45bb-9bf8-629ef2ddde03"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"maxpool", "[", 
   RowBox[{"array_", ",", "spec_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"dims", "=", 
       RowBox[{"Dimensions", "[", "array", "]"}]}], ",", "rank", ",", "shape",
       ",", "pooledDims", ",", "reshapedArray"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"rank", "=", 
      RowBox[{"Length", "[", "dims", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"rank", "!=", 
        RowBox[{"Length", "[", "spec", "]"}]}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"shape", "=", 
      RowBox[{"DeleteCases", "[", 
       RowBox[{
        RowBox[{"Riffle", "[", 
         RowBox[{
          RowBox[{"dims", "/", "spec"}], ",", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{"#", ",", "\"\<pool\>\""}], "}"}], "&"}], "/@", 
           "spec"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "\"\<pool\>\""}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"pooledDims", "=", 
      RowBox[{"First", "/@", 
       RowBox[{"Position", "[", 
        RowBox[{"shape", ",", "\"\<pool\>\""}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"shape", "=", 
      RowBox[{"DeleteCases", "[", 
       RowBox[{
        RowBox[{"Flatten", "[", "shape", "]"}], ",", "\"\<pool\>\""}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"reshapedArray", "=", 
      RowBox[{"ArrayReshape", "[", 
       RowBox[{"array", ",", "shape"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"ArrayReduce", "[", 
      RowBox[{"Max", ",", "reshapedArray", ",", "pooledDims"}], "]"}]}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"maxpoolD", "[", 
   RowBox[{"array_", ",", "spec_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"pooled", "=", 
       RowBox[{"maxpool", "[", 
        RowBox[{"array", ",", "spec"}], "]"}]}], ",", "shift", ",", "aug", ",",
       "pre"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"shift", "=", 
      RowBox[{
       RowBox[{"Max", "[", 
        RowBox[{"Abs", "[", "pooled", "]"}], "]"}], "/", 
       SqrtBox["2"]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"aug", "=", 
      RowBox[{
       RowBox[{"KroneckerProduct", "[", 
        RowBox[{"pooled", ",", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"1.", ",", "spec"}], "]"}]}], "]"}], "+", "shift"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"pre", "=", 
      RowBox[{"Chop", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"array", "+", "shift"}], ")"}], "/", "aug"}], "-", "1"}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Normal", "[", 
      RowBox[{"SparseArray", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Position", "[", 
          RowBox[{"pre", ",", "0"}], "]"}], "->", "1"}], ",", 
        RowBox[{"Dimensions", "[", "pre", "]"}]}], "]"}], "]"}]}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"arrayContract", "[", 
   RowBox[{"t1_", ",", "inds1_", ",", "t2_", ",", "inds2_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"dims1", "=", 
       RowBox[{"Dimensions", "[", "t1", "]"}]}], ",", 
      RowBox[{"dims2", "=", 
       RowBox[{"Dimensions", "[", "t2", "]"}]}], ",", 
      RowBox[{"l", "=", 
       RowBox[{"Length", "[", "inds1", "]"}]}], ",", "tt1", ",", "tt2", ",", 
      "contractedDims", ",", "dim1", ",", "dim2", ",", "transposePerm1", ",", 
      "transposePerm2"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"dims1", "[", 
          RowBox[{"[", "inds1", "]"}], "]"}], "!=", 
         RowBox[{"dims2", "[", 
          RowBox[{"[", "inds2", "]"}], "]"}]}], "||", 
        RowBox[{
         RowBox[{"Length", "[", "inds2", "]"}], "!=", "l"}]}], ",", 
       RowBox[{"Return", "[", "$Failed", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"dim1", "=", 
      RowBox[{"Length", "[", "dims1", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"dim2", "=", 
      RowBox[{"Length", "[", "dims2", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"transposePerm1", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"0", ",", "dim1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"transposePerm2", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"0", ",", "dim2"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"transposePerm1", "[", 
       RowBox[{"[", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"Complement", "[", 
           RowBox[{
            RowBox[{"Range", "[", "dim1", "]"}], ",", "inds1"}], "]"}], ",", 
          "inds1"}], "]"}], "]"}], "]"}], "=", 
      RowBox[{"Range", "[", "dim1", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"transposePerm2", "[", 
       RowBox[{"[", 
        RowBox[{"Join", "[", 
         RowBox[{"inds2", ",", 
          RowBox[{"Complement", "[", 
           RowBox[{
            RowBox[{"Range", "[", "dim2", "]"}], ",", "inds2"}], "]"}]}], 
         "]"}], "]"}], "]"}], "=", 
      RowBox[{"Range", "[", "dim2", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"tt1", "=", 
      RowBox[{"Transpose", "[", 
       RowBox[{"t1", ",", "transposePerm1"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"tt2", "=", 
      RowBox[{"Transpose", "[", 
       RowBox[{"t2", ",", "transposePerm2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"dims1", "=", 
      RowBox[{"Dimensions", "[", "tt1", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"dims2", "=", 
      RowBox[{"Dimensions", "[", "tt2", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"contractedDims", "=", 
      RowBox[{"Times", "@@", 
       RowBox[{"dims2", "[", 
        RowBox[{"[", 
         RowBox[{";;", "l"}], "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"dims1", "[", 
       RowBox[{"[", 
        RowBox[{
         RowBox[{"-", "l"}], ";;"}], "]"}], "]"}], "=", "Nothing"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"dims2", "[", 
       RowBox[{"[", 
        RowBox[{";;", "l"}], "]"}], "]"}], "=", "Nothing"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"dims1", "=", 
      RowBox[{"Append", "[", 
       RowBox[{"dims1", ",", "contractedDims"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"dims2", "=", 
      RowBox[{"Prepend", "[", 
       RowBox[{"dims2", ",", "contractedDims"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"tt1", "=", 
      RowBox[{"ArrayReshape", "[", 
       RowBox[{"tt1", ",", "dims1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"tt2", "=", 
      RowBox[{"ArrayReshape", "[", 
       RowBox[{"tt2", ",", "dims2"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"tt1", ".", "tt2"}]}]}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.976221315309025*^9, 3.976221344504764*^9}, 
   3.9762214350141487`*^9, {3.976225065856852*^9, 3.976225066041827*^9}, {
   3.9762250983322163`*^9, 3.976225116553341*^9}, {3.97622853211406*^9, 
   3.976228539599065*^9}, {3.976228681096571*^9, 3.97622868249146*^9}, {
   3.976229272208712*^9, 3.976229275436349*^9}, {3.9762338804869328`*^9, 
   3.976233954790728*^9}, {3.976234205389256*^9, 3.976234224856764*^9}, 
   3.976234270891054*^9, {3.9762343206183043`*^9, 3.976234321010861*^9}, {
   3.9762410814610662`*^9, 3.976241084049829*^9}, {3.9762450128353167`*^9, 
   3.97624516967654*^9}, {3.976245262963437*^9, 3.9762452703252077`*^9}, {
   3.976245679465605*^9, 3.976245700193479*^9}, {3.976282360244246*^9, 
   3.976282360865932*^9}, {3.976454781311284*^9, 3.976454782256295*^9}, 
   3.976548088170537*^9, {3.976548130470015*^9, 3.976548130630406*^9}, 
   3.976548892928172*^9, {3.97657327216982*^9, 3.976573312003903*^9}, {
   3.976573351805748*^9, 3.976573360715334*^9}, {3.976573416744833*^9, 
   3.97657342489563*^9}, {3.9765763733606586`*^9, 3.9765764018649817`*^9}, {
   3.976576538426118*^9, 3.976576550388253*^9}},
 CellLabel->
  "In[218]:=",ExpressionUUID->"fca58653-f31e-4634-847c-0491020d8cbf"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"batchSize", "=", "77"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"lr", "=", 
   SuperscriptBox["10", 
    RowBox[{"-", "2"}]]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"epochs", "=", "40"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"dims", "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"32", ",", "3", ",", "3"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"64", ",", "3", ",", "3"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"64", ",", "3", ",", "3"}], "}"}], ",", 
     RowBox[{"{", "}"}], ",", 
     RowBox[{"{", "7744", "}"}], ",", 
     RowBox[{"{", "128", "}"}], ",", 
     RowBox[{"{", "10", "}"}]}], "}"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.9762980640396442`*^9, 3.976298064183342*^9}, {
   3.976327858300624*^9, 3.97632785845047*^9}, {3.976331262459462*^9, 
   3.976331262691091*^9}, {3.97637314633134*^9, 3.976373149894658*^9}, {
   3.976373910917623*^9, 3.976373923540926*^9}, {3.976373953652877*^9, 
   3.9763739887846212`*^9}, {3.976374065269165*^9, 3.976374072974678*^9}, {
   3.976374143346034*^9, 3.9763741665702267`*^9}, {3.976374405272834*^9, 
   3.9763744147987213`*^9}, {3.976376971230455*^9, 3.9763769825676394`*^9}, {
   3.976455005638842*^9, 3.9764550058660717`*^9}, {3.9764636557240553`*^9, 
   3.976463655904667*^9}, {3.976483557901956*^9, 3.976483574558272*^9}, 
   3.976486564884426*^9, {3.976544386895584*^9, 3.9765443870204353`*^9}, {
   3.9765468847371492`*^9, 3.976546884890931*^9}, {3.9765491144824753`*^9, 
   3.9765491145564737`*^9}, {3.976550112132271*^9, 3.976550112213924*^9}, {
   3.97655103873501*^9, 3.976551039429633*^9}, {3.97656232302349*^9, 
   3.976562326261456*^9}, {3.976580090648809*^9, 3.9765800916205807`*^9}, {
   3.97658364469777*^9, 3.976583646975813*^9}, 3.9766147759961863`*^9, {
   3.976714846111369*^9, 3.976714858111823*^9}, {3.9767552130160418`*^9, 
   3.976755224049386*^9}, {3.976914788287409*^9, 3.976914788388994*^9}},
 CellLabel->
  "In[221]:=",ExpressionUUID->"3b5522d1-65d1-4059-9504-0c75cec02f1c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SeedRandom", "[", "0", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "1", "]"}], "=", 
   RowBox[{
    RowBox[{"RandomVariate", "[", 
     RowBox[{
      RowBox[{"NormalDistribution", "[", "]"}], ",", 
      RowBox[{"dims", "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], "]"}], 
    SqrtBox[
     RowBox[{"2.", "/", 
      RowBox[{"Times", "@@", 
       RowBox[{"dims", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", 
          RowBox[{
           RowBox[{"-", "2"}], ";;"}]}], "]"}], "]"}]}]}]]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "2", "]"}], "=", 
   RowBox[{
    RowBox[{"RandomVariate", "[", 
     RowBox[{
      RowBox[{"NormalDistribution", "[", "]"}], ",", 
      RowBox[{"Insert", "[", 
       RowBox[{
        RowBox[{"dims", "[", 
         RowBox[{"[", "2", "]"}], "]"}], ",", 
        RowBox[{"dims", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", "2"}], "]"}]}], "]"}], 
    SqrtBox[
     RowBox[{"2.", "/", 
      RowBox[{"Times", "@@", 
       RowBox[{"Flatten", "[", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"dims", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{"dims", "[", 
           RowBox[{"[", 
            RowBox[{"2", ",", 
             RowBox[{
              RowBox[{"-", "2"}], ";;"}]}], "]"}], "]"}]}], "}"}], 
        "]"}]}]}]]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "3", "]"}], "=", 
   RowBox[{
    RowBox[{"RandomVariate", "[", 
     RowBox[{
      RowBox[{"NormalDistribution", "[", "]"}], ",", 
      RowBox[{"Insert", "[", 
       RowBox[{
        RowBox[{"dims", "[", 
         RowBox[{"[", "3", "]"}], "]"}], ",", 
        RowBox[{"dims", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "1"}], "]"}], "]"}], ",", "2"}], "]"}]}], "]"}], 
    SqrtBox[
     RowBox[{"2.", "/", 
      RowBox[{"Times", "@@", 
       RowBox[{"Flatten", "[", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"dims", "[", 
           RowBox[{"[", 
            RowBox[{"2", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{"dims", "[", 
           RowBox[{"[", 
            RowBox[{"3", ",", 
             RowBox[{
              RowBox[{"-", "2"}], ";;"}]}], "]"}], "]"}]}], "}"}], 
        "]"}]}]}]]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "5", "]"}], "=", 
   RowBox[{
    RowBox[{"RandomVariate", "[", 
     RowBox[{
      RowBox[{"NormalDistribution", "[", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"dims", "[", 
         RowBox[{"[", 
          RowBox[{"5", ",", "1"}], "]"}], "]"}], ",", "7744"}], "}"}]}], 
     "]"}], 
    SqrtBox[
     RowBox[{"2.", "/", "7744"}]]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"b", "[", "5", "]"}], "=", 
   RowBox[{"ConstantArray", "[", 
    RowBox[{"0.", ",", 
     RowBox[{"dims", "[", 
      RowBox[{"[", 
       RowBox[{"5", ",", "1"}], "]"}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "6", "]"}], "=", 
   RowBox[{
    RowBox[{"RandomVariate", "[", 
     RowBox[{
      RowBox[{"NormalDistribution", "[", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"dims", "[", 
         RowBox[{"[", 
          RowBox[{"6", ",", "1"}], "]"}], "]"}], ",", 
        RowBox[{"dims", "[", 
         RowBox[{"[", 
          RowBox[{"5", ",", "1"}], "]"}], "]"}]}], "}"}]}], "]"}], 
    SqrtBox[
     RowBox[{"2.", "/", 
      RowBox[{"dims", "[", 
       RowBox[{"[", 
        RowBox[{"5", ",", "1"}], "]"}], "]"}]}]]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"b", "[", "6", "]"}], "=", 
   RowBox[{"ConstantArray", "[", 
    RowBox[{"0.", ",", 
     RowBox[{"dims", "[", 
      RowBox[{"[", 
       RowBox[{"6", ",", "1"}], "]"}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "7", "]"}], "=", 
   RowBox[{
    RowBox[{"RandomVariate", "[", 
     RowBox[{
      RowBox[{"NormalDistribution", "[", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"dims", "[", 
         RowBox[{"[", 
          RowBox[{"7", ",", "1"}], "]"}], "]"}], ",", 
        RowBox[{"dims", "[", 
         RowBox[{"[", 
          RowBox[{"6", ",", "1"}], "]"}], "]"}]}], "}"}]}], "]"}], 
    SqrtBox[
     RowBox[{"2.", "/", 
      RowBox[{"dims", "[", 
       RowBox[{"[", 
        RowBox[{"6", ",", "1"}], "]"}], "]"}]}]]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"b", "[", "7", "]"}], "=", 
   RowBox[{"ConstantArray", "[", 
    RowBox[{"0.", ",", 
     RowBox[{"dims", "[", 
      RowBox[{"[", 
       RowBox[{"7", ",", "1"}], "]"}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "1", "]"}], "=", 
   RowBox[{"ArrayReshape", "[", 
    RowBox[{
     RowBox[{"Transpose", "[", 
      RowBox[{
       RowBox[{"W", "[", "1", "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"3", ",", "1", ",", "2"}], "}"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"3", " ", "3"}], ",", "32"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "2", "]"}], "=", 
   RowBox[{"ArrayReshape", "[", 
    RowBox[{
     RowBox[{"Transpose", "[", 
      RowBox[{
       RowBox[{"W", "[", "2", "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"4", ",", "3", ",", "1", ",", "2"}], "}"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"3", " ", "3", " ", "32"}], ",", "64"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "3", "]"}], "=", 
   RowBox[{"ArrayReshape", "[", 
    RowBox[{
     RowBox[{"Transpose", "[", 
      RowBox[{
       RowBox[{"W", "[", "3", "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"4", ",", "3", ",", "1", ",", "2"}], "}"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"3", " ", "3", " ", "64"}], ",", "64"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Windices", "=", 
   RowBox[{"{", 
    RowBox[{"1", ",", "2", ",", "3", ",", "5", ",", "6", ",", "7"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"bindices", "=", 
   RowBox[{"{", 
    RowBox[{"5", ",", "6", ",", "7"}], "}"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.976399336201621*^9, 3.976399340326425*^9}, {
   3.9763995618946037`*^9, 3.976399569575058*^9}, {3.976399611341649*^9, 
   3.976399645770997*^9}, {3.976399695899868*^9, 3.976399736114114*^9}, 
   3.976400832903411*^9, {3.976400874642943*^9, 3.9764008793355017`*^9}, {
   3.9764012701005573`*^9, 3.9764012702445793`*^9}, {3.976407457187346*^9, 
   3.976407493108062*^9}, {3.976407525059142*^9, 3.976407526081644*^9}, {
   3.976407650271933*^9, 3.976407736805656*^9}, {3.976407828011262*^9, 
   3.976407838926815*^9}, {3.976410766664958*^9, 3.9764108051392612`*^9}, {
   3.9764116439092703`*^9, 3.97641164451742*^9}, 3.9765447971068983`*^9, {
   3.976573055383299*^9, 3.97657305588586*^9}},
 CellLabel->
  "In[225]:=",ExpressionUUID->"4146b0e3-987e-4d00-b898-476541cd0796"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"dist", "[", "img_", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"A", ",", "Z", ",", "y"}], "}"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"A", "[", "1", "]"}], "=", 
      RowBox[{
       RowBox[{"ArrayReshape", "[", 
        RowBox[{
         RowBox[{"Partition", "[", 
          RowBox[{"img", ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"26", ",", "26", ",", 
           RowBox[{"3", " ", "3"}]}], "}"}]}], "]"}], ".", 
       RowBox[{"W", "[", "1", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Z", "[", "1", "]"}], "=", 
      RowBox[{"Ramp", "[", 
       RowBox[{"A", "[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "[", "2", "]"}], "=", 
      RowBox[{
       RowBox[{"ArrayReshape", "[", 
        RowBox[{
         RowBox[{"Partition", "[", 
          RowBox[{
           RowBox[{"Z", "[", "1", "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"24", ",", "24", ",", 
           RowBox[{"3", " ", "3", " ", "32"}]}], "}"}]}], "]"}], ".", 
       RowBox[{"W", "[", "2", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Z", "[", "2", "]"}], "=", 
      RowBox[{"Ramp", "[", 
       RowBox[{"A", "[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "[", "3", "]"}], "=", 
      RowBox[{
       RowBox[{"ArrayReshape", "[", 
        RowBox[{
         RowBox[{"Partition", "[", 
          RowBox[{
           RowBox[{"Z", "[", "2", "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"3", ",", "3"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"22", ",", "22", ",", 
           RowBox[{"3", " ", "3", " ", "64"}]}], "}"}]}], "]"}], ".", 
       RowBox[{"W", "[", "3", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Z", "[", "3", "]"}], "=", 
      RowBox[{"Ramp", "[", 
       RowBox[{"A", "[", "3", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "[", "4", "]"}], "=", 
      RowBox[{"Transpose", "[", 
       RowBox[{
        RowBox[{"maxpool", "[", 
         RowBox[{
          RowBox[{"Z", "[", "3", "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"2", ",", "2", ",", "1"}], "}"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "3", ",", "1"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Z", "[", "4", "]"}], "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{"A", "[", "4", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "[", "5", "]"}], "=", 
      RowBox[{
       RowBox[{
        RowBox[{"W", "[", "5", "]"}], ".", 
        RowBox[{"Z", "[", "4", "]"}]}], "+", 
       RowBox[{"b", "[", "5", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Z", "[", "5", "]"}], "=", 
      RowBox[{"Ramp", "[", 
       RowBox[{"A", "[", "5", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "[", "6", "]"}], "=", 
      RowBox[{
       RowBox[{
        RowBox[{"W", "[", "6", "]"}], ".", 
        RowBox[{"Z", "[", "5", "]"}]}], "+", 
       RowBox[{"b", "[", "6", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Z", "[", "6", "]"}], "=", 
      RowBox[{"Ramp", "[", 
       RowBox[{"A", "[", "6", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "[", "7", "]"}], "=", 
      RowBox[{
       RowBox[{
        RowBox[{"W", "[", "7", "]"}], ".", 
        RowBox[{"Z", "[", "6", "]"}]}], "+", 
       RowBox[{"b", "[", "7", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"y", "=", 
      RowBox[{"Exp", "[", 
       RowBox[{"A", "[", "7", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"y", "=", 
      RowBox[{"y", "/", 
       RowBox[{"Total", "[", "y", "]"}]}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pred", "[", "img_", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"y", "=", 
      RowBox[{"dist", "[", "img", "]"}]}], "}"}], ",", 
    RowBox[{"classes", "[", 
     RowBox[{"[", 
      RowBox[{
       RowBox[{"FirstPosition", "[", 
        RowBox[{"y", ",", 
         RowBox[{"Max", "[", "y", "]"}]}], "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"batchDist", "[", 
   RowBox[{"block_", ",", 
    RowBox[{"batchSize_", ":", "512"}]}], 
   RowBox[{"(*", "batchSize", "*)"}], "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Length", "[", "block", "]"}], ">", "batchSize"}], ",", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"blocks", "=", 
        RowBox[{"Partition", "[", 
         RowBox[{"block", ",", 
          RowBox[{"UpTo", "[", "batchSize", "]"}]}], "]"}]}], "}"}], ",", 
      RowBox[{"Join", "@@", 
       RowBox[{"(", 
        RowBox[{"Parallelize", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"batchDist", "[", 
             RowBox[{"#", ",", "batchSize"}], "]"}], "&"}], "/@", "blocks"}], 
          ",", 
          RowBox[{"Method", "->", "\"\<FinestGrained\>\""}]}], "]"}], 
        ")"}]}]}], "]"}], ",", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"A", ",", "Z", ",", "y"}], "}"}], ",", 
      RowBox[{
       RowBox[{
        RowBox[{"Z", "[", "0", "]"}], "=", "block"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"A", "[", "1", "]"}], "=", 
        RowBox[{"Dot", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"ArrayReshape", "[", 
             RowBox[{
              RowBox[{"Partition", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", 
                 RowBox[{"3", ",", "3"}], "}"}], ",", 
                RowBox[{"{", 
                 RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"26", ",", "26", ",", 
                RowBox[{"3", " ", "3"}]}], "}"}]}], "]"}], "&"}], "/@", 
           RowBox[{"Z", "[", "0", "]"}]}], ",", 
          RowBox[{"W", "[", "1", "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Z", "[", "1", "]"}], "=", 
        RowBox[{"Ramp", "[", 
         RowBox[{"A", "[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"A", "[", "2", "]"}], "=", 
        RowBox[{"Dot", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"ArrayReshape", "[", 
             RowBox[{
              RowBox[{"Partition", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", 
                 RowBox[{"3", ",", "3"}], "}"}], ",", 
                RowBox[{"{", 
                 RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"24", ",", "24", ",", 
                RowBox[{"3", " ", "3", " ", "32"}]}], "}"}]}], "]"}], "&"}], "/@", 
           RowBox[{"Z", "[", "1", "]"}]}], ",", 
          RowBox[{"W", "[", "2", "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Z", "[", "2", "]"}], "=", 
        RowBox[{"Ramp", "[", 
         RowBox[{"A", "[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"A", "[", "3", "]"}], "=", 
        RowBox[{"Dot", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"ArrayReshape", "[", 
             RowBox[{
              RowBox[{"Partition", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", 
                 RowBox[{"3", ",", "3"}], "}"}], ",", 
                RowBox[{"{", 
                 RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"22", ",", "22", ",", 
                RowBox[{"3", " ", "3", " ", "64"}]}], "}"}]}], "]"}], "&"}], "/@", 
           RowBox[{"Z", "[", "2", "]"}]}], ",", 
          RowBox[{"W", "[", "3", "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Z", "[", "3", "]"}], "=", 
        RowBox[{"Ramp", "[", 
         RowBox[{"A", "[", "3", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"A", "[", "4", "]"}], "=", 
        RowBox[{"Transpose", "[", 
         RowBox[{
          RowBox[{"maxpool", "[", 
           RowBox[{
            RowBox[{"Z", "[", "3", "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "2", ",", "2", ",", "1"}], "}"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"1", ",", "3", ",", "4", ",", "2"}], "}"}]}], "]"}]}], ";",
        "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Z", "[", "4", "]"}], "=", 
        RowBox[{"Flatten", "/@", 
         RowBox[{"A", "[", "4", "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"A", "[", "5", "]"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{"#", "+", 
           RowBox[{"b", "[", "5", "]"}]}], "&"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Z", "[", "4", "]"}], ".", 
           RowBox[{"Transpose", "[", 
            RowBox[{"W", "[", "5", "]"}], "]"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Z", "[", "5", "]"}], "=", 
        RowBox[{"Ramp", "[", 
         RowBox[{"A", "[", "5", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"A", "[", "6", "]"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{"#", "+", 
           RowBox[{"b", "[", "6", "]"}]}], "&"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Z", "[", "5", "]"}], ".", 
           RowBox[{"Transpose", "[", 
            RowBox[{"W", "[", "6", "]"}], "]"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Z", "[", "6", "]"}], "=", 
        RowBox[{"Ramp", "[", 
         RowBox[{"A", "[", "6", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"A", "[", "7", "]"}], "=", 
        RowBox[{
         RowBox[{
          RowBox[{"#", "+", 
           RowBox[{"b", "[", "7", "]"}]}], "&"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Z", "[", "6", "]"}], ".", 
           RowBox[{"Transpose", "[", 
            RowBox[{"W", "[", "7", "]"}], "]"}]}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"y", "=", 
        RowBox[{"Exp", "[", 
         RowBox[{"A", "[", "7", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"y", "=", 
        RowBox[{"y", "/", 
         RowBox[{"(", 
          RowBox[{"Total", "/@", "y"}], ")"}]}]}]}]}], "]"}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"batchPred", "[", "block_", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"y", "=", 
      RowBox[{"batchDist", "[", "block", "]"}]}], "}"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"classes", "[", 
       RowBox[{"[", 
        RowBox[{
         RowBox[{"FirstPosition", "[", 
          RowBox[{"#", ",", 
           RowBox[{"Max", "[", "#", "]"}]}], "]"}], "[", 
         RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}], "&"}], "/@", "y"}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.976296984690419*^9, 3.976297015081997*^9}, {
  3.9763012115254717`*^9, 3.976301232442272*^9}, {3.9764117067609873`*^9, 
  3.976411756451091*^9}, {3.976413077496958*^9, 3.976413085448344*^9}, {
  3.976462275263031*^9, 3.9764623601528397`*^9}, {3.9765403868758907`*^9, 
  3.976540390707795*^9}, {3.976540433529017*^9, 3.9765404392523327`*^9}, {
  3.976543879451189*^9, 3.976543879640815*^9}, {3.976544459842349*^9, 
  3.9765445114836617`*^9}, {3.976544564914873*^9, 3.9765446471241407`*^9}, {
  3.976544778721971*^9, 3.976544782688443*^9}, {3.976548127556155*^9, 
  3.976548127847208*^9}},
 CellLabel->
  "In[240]:=",ExpressionUUID->"9894ce5b-4ff8-4f50-9fb9-f10d2703670c"],

Cell[BoxData[{
 RowBox[{"AbsoluteTiming", "[", 
  RowBox[{
   RowBox[{"preds", "=", 
    RowBox[{"batchPred", "[", "data", "]"}]}], ";"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"matches", "[", "0", "]"}], "=", 
   RowBox[{"MapThread", "[", 
    RowBox[{"Equal", ",", 
     RowBox[{"{", 
      RowBox[{"preds", ",", "labels"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"correct", "[", "0", "]"}], "=", 
  RowBox[{"Count", "[", 
   RowBox[{
    RowBox[{"matches", "[", "0", "]"}], ",", "True"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"acc", "[", "0", "]"}], "=", 
  RowBox[{"N", "[", 
   RowBox[{
    RowBox[{"correct", "[", "0", "]"}], "/", "nTrain"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.976373019816751*^9, 3.976373122861408*^9}, 
   3.976373421858036*^9, {3.976411768540997*^9, 3.976411771016037*^9}, 
   3.976454585610406*^9, {3.976544852534218*^9, 3.976544855329576*^9}},
 CellLabel->
  "In[244]:=",ExpressionUUID->"13faf20f-1b8f-4e15-81a3-781474368cf1"],

Cell[BoxData[
 RowBox[{"Monitor", "[", 
  RowBox[{
   RowBox[{"Do", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"shuffle", "=", 
       RowBox[{"Partition", "[", 
        RowBox[{
         RowBox[{"RandomSample", "[", 
          RowBox[{"Range", "[", "nTrain", "]"}], "]"}], ",", 
         RowBox[{"UpTo", "[", "batchSize", "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"nBatches", "=", 
       RowBox[{"Length", "[", "shuffle", "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"batch", "=", 
          RowBox[{"shuffle", "[", 
           RowBox[{"[", "p", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"nBatch", "=", 
          RowBox[{"Length", "[", "batch", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"dataBatch", "=", 
          RowBox[{"data", "[", 
           RowBox[{"[", "batch", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"rVec", "=", 
          RowBox[{"pos", "/@", 
           RowBox[{"labels", "[", 
            RowBox[{"[", "batch", "]"}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"constructedW", "[", "3", "]"}], "=", 
          RowBox[{"ArrayReshape", "[", 
           RowBox[{
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"Reverse", "[", 
               RowBox[{"ArrayReshape", "[", 
                RowBox[{
                 RowBox[{"W", "[", "3", "]"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"9", ",", "64", ",", "64"}], "}"}]}], "]"}], "]"}], 
              ",", 
              RowBox[{"{", 
               RowBox[{"1", ",", "3", ",", "2"}], "}"}]}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"576", ",", "64"}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"constructedW", "[", "2", "]"}], "=", 
          RowBox[{"ArrayReshape", "[", 
           RowBox[{
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"Reverse", "[", 
               RowBox[{"ArrayReshape", "[", 
                RowBox[{
                 RowBox[{"W", "[", "2", "]"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"9", ",", "32", ",", "64"}], "}"}]}], "]"}], "]"}], 
              ",", 
              RowBox[{"{", 
               RowBox[{"1", ",", "3", ",", "2"}], "}"}]}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"576", ",", "32"}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"Block", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
            "Z", ",", "A", ",", "y", ",", "label", ",", "labelVec", ",", "e", 
             ",", "g3", ",", "g2", ",", "g1"}], "}"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"Z", "[", "0", "]"}], "=", "dataBatch"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"A", "[", "1", "]"}], "=", 
             RowBox[{"Dot", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"ArrayReshape", "[", 
                  RowBox[{
                   RowBox[{"Partition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{"3", ",", "3"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"26", ",", "26", ",", 
                    RowBox[{"3", " ", "3"}]}], "}"}]}], "]"}], "&"}], "/@", 
                RowBox[{"Z", "[", "0", "]"}]}], ",", 
               RowBox[{"W", "[", "1", "]"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Z", "[", "1", "]"}], "=", 
             RowBox[{"Ramp", "[", 
              RowBox[{"A", "[", "1", "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"A", "[", "2", "]"}], "=", 
             RowBox[{"Dot", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"ArrayReshape", "[", 
                  RowBox[{
                   RowBox[{"Partition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{"3", ",", "3"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"24", ",", "24", ",", 
                    RowBox[{"3", " ", "3", " ", "32"}]}], "}"}]}], "]"}], 
                 "&"}], "/@", 
                RowBox[{"Z", "[", "1", "]"}]}], ",", 
               RowBox[{"W", "[", "2", "]"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Z", "[", "2", "]"}], "=", 
             RowBox[{"Ramp", "[", 
              RowBox[{"A", "[", "2", "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"A", "[", "3", "]"}], "=", 
             RowBox[{"Dot", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"ArrayReshape", "[", 
                  RowBox[{
                   RowBox[{"Partition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{"3", ",", "3"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"22", ",", "22", ",", 
                    RowBox[{"3", " ", "3", " ", "64"}]}], "}"}]}], "]"}], 
                 "&"}], "/@", 
                RowBox[{"Z", "[", "2", "]"}]}], ",", 
               RowBox[{"W", "[", "3", "]"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Z", "[", "3", "]"}], "=", 
             RowBox[{"Ramp", "[", 
              RowBox[{"A", "[", "3", "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"A", "[", "4", "]"}], "=", 
             RowBox[{"Transpose", "[", 
              RowBox[{
               RowBox[{"maxpool", "[", 
                RowBox[{
                 RowBox[{"Z", "[", "3", "]"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"1", ",", "2", ",", "2", ",", "1"}], "}"}]}], "]"}],
                ",", 
               RowBox[{"{", 
                RowBox[{"1", ",", "3", ",", "4", ",", "2"}], "}"}]}], "]"}]}],
             ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Z", "[", "4", "]"}], "=", 
             RowBox[{"Flatten", "/@", 
              RowBox[{"A", "[", "4", "]"}]}]}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"A", "[", "5", "]"}], "=", 
             RowBox[{
              RowBox[{
               RowBox[{"#", "+", 
                RowBox[{"b", "[", "5", "]"}]}], "&"}], "/@", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Z", "[", "4", "]"}], ".", 
                RowBox[{"Transpose", "[", 
                 RowBox[{"W", "[", "5", "]"}], "]"}]}], ")"}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Z", "[", "5", "]"}], "=", 
             RowBox[{"Ramp", "[", 
              RowBox[{"A", "[", "5", "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"A", "[", "6", "]"}], "=", 
             RowBox[{
              RowBox[{
               RowBox[{"#", "+", 
                RowBox[{"b", "[", "6", "]"}]}], "&"}], "/@", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Z", "[", "5", "]"}], ".", 
                RowBox[{"Transpose", "[", 
                 RowBox[{"W", "[", "6", "]"}], "]"}]}], ")"}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Z", "[", "6", "]"}], "=", 
             RowBox[{"Ramp", "[", 
              RowBox[{"A", "[", "6", "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"A", "[", "7", "]"}], "=", 
             RowBox[{
              RowBox[{
               RowBox[{"#", "+", 
                RowBox[{"b", "[", "7", "]"}]}], "&"}], "/@", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Z", "[", "6", "]"}], ".", 
                RowBox[{"Transpose", "[", 
                 RowBox[{"W", "[", "7", "]"}], "]"}]}], ")"}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"y", "=", 
             RowBox[{"Exp", "[", 
              RowBox[{"A", "[", "7", "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"y", "=", 
             RowBox[{"y", "/", 
              RowBox[{"(", 
               RowBox[{"Total", "/@", "y"}], ")"}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"labelMat", "=", 
             RowBox[{
              RowBox[{
               RowBox[{"UnitVector", "[", 
                RowBox[{"nClasses", ",", "#"}], "]"}], "&"}], "/@", 
              "rVec"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"e", "[", "7", "]"}], "=", 
             RowBox[{"y", "-", "labelMat"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"Do", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"e", "[", "j", "]"}], "=", 
               RowBox[{
                RowBox[{
                 RowBox[{"e", "[", 
                  RowBox[{"j", "+", "1"}], "]"}], ".", 
                 RowBox[{"W", "[", 
                  RowBox[{"j", "+", "1"}], "]"}]}], 
                RowBox[{"Unitize", "[", 
                 RowBox[{"Z", "[", "j", "]"}], "]"}]}]}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "6", ",", "5", ",", 
                RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"e", "[", "4", "]"}], "=", 
             RowBox[{
              RowBox[{"e", "[", "5", "]"}], ".", 
              RowBox[{"W", "[", "5", "]"}]}]}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"e", "[", "3", "]"}], "=", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"Transpose", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"maxpoolD", "[", 
                   RowBox[{
                    RowBox[{"Z", "[", "3", "]"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "2", ",", "2", ",", "1"}], "}"}]}], 
                   "]"}], 
                  RowBox[{"Unitize", "[", 
                   RowBox[{"Z", "[", "3", "]"}], "]"}]}], ",", 
                 RowBox[{"{", 
                  RowBox[{"1", ",", "3", ",", "4", ",", "2"}], "}"}]}], "]"}],
                ")"}], 
              RowBox[{"(", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"KroneckerProduct", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"ConstantArray", "[", 
                    RowBox[{"1.", ",", 
                    RowBox[{"{", 
                    RowBox[{"2", ",", "2"}], "}"}]}], "]"}]}], "]"}], "&"}], "/@", 
                  RowBox[{"ArrayReshape", "[", 
                   RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{"64", ",", "11", ",", "11"}], "}"}]}], "]"}]}], 
                 "&"}], "/@", 
                RowBox[{"e", "[", "4", "]"}]}], ")"}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"e", "[", "2", "]"}], "=", 
             RowBox[{"Transpose", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"Map", "[", 
                  RowBox[{"Flatten", ",", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Partition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{"3", ",", "3"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "1"}], "}"}]}], "]"}], "&"}], "/@", 
                    RowBox[{"Transpose", "[", 
                    RowBox[{
                    RowBox[{"ArrayPad", "[", 
                    RowBox[{
                    RowBox[{"e", "[", "3", "]"}], ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"0", ",", "0"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"0", ",", "0"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"2", ",", "2"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"2", ",", "2"}], "}"}]}], "}"}]}], "]"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "4", ",", "2", ",", "3"}], "}"}]}], 
                    "]"}]}], ",", 
                   RowBox[{"{", "3", "}"}]}], "]"}], ".", 
                 RowBox[{"constructedW", "[", "3", "]"}]}], " ", 
                RowBox[{"Unitize", "[", 
                 RowBox[{"Z", "[", "2", "]"}], "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"1", ",", "3", ",", "4", ",", "2"}], "}"}]}], "]"}]}],
             ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"e", "[", "1", "]"}], "=", 
             RowBox[{"Transpose", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"Map", "[", 
                  RowBox[{"Flatten", ",", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Partition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{"3", ",", "3"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "1"}], "}"}]}], "]"}], "&"}], "/@", 
                    RowBox[{"Transpose", "[", 
                    RowBox[{
                    RowBox[{"ArrayPad", "[", 
                    RowBox[{
                    RowBox[{"e", "[", "2", "]"}], ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"0", ",", "0"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"0", ",", "0"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"2", ",", "2"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"2", ",", "2"}], "}"}]}], "}"}]}], "]"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "4", ",", "2", ",", "3"}], "}"}]}], 
                    "]"}]}], ",", 
                   RowBox[{"{", "3", "}"}]}], "]"}], ".", 
                 RowBox[{"constructedW", "[", "2", "]"}]}], " ", 
                RowBox[{"Unitize", "[", 
                 RowBox[{"Z", "[", "1", "]"}], "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"1", ",", "3", ",", "4", ",", "2"}], "}"}]}], "]"}]}],
             ";", "\[IndentingNewLine]", 
            RowBox[{"Do", "[", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"gradQW", "[", "j", "]"}], "=", 
                RowBox[{
                 RowBox[{"Transpose", "[", 
                  RowBox[{"e", "[", "j", "]"}], "]"}], ".", 
                 RowBox[{"Z", "[", 
                  RowBox[{"j", "-", "1"}], "]"}]}]}], ";", 
               RowBox[{
                RowBox[{"gradQb", "[", "j", "]"}], "=", 
                RowBox[{"Total", "[", 
                 RowBox[{"e", "[", "j", "]"}], "]"}]}]}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "5", ",", "7"}], "}"}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"g3", "=", 
             RowBox[{"arrayContract", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"ArrayReshape", "[", 
                  RowBox[{
                   RowBox[{"Partition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{"22", ",", "22"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"3", ",", "3", ",", 
                    RowBox[{"22", " ", "22"}], ",", "64"}], "}"}]}], "]"}], 
                 "&"}], "/@", 
                RowBox[{"Z", "[", "2", "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"1", ",", "4"}], "}"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"ArrayReshape", "[", 
                  RowBox[{"#", ",", 
                   RowBox[{"{", 
                    RowBox[{"64", ",", 
                    RowBox[{"22", " ", "22"}]}], "}"}]}], "]"}], "&"}], "/@", 
                
                RowBox[{"e", "[", "3", "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"1", ",", "3"}], "}"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"g2", "=", 
             RowBox[{"arrayContract", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"ArrayReshape", "[", 
                  RowBox[{
                   RowBox[{"Partition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{"24", ",", "24"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"3", ",", "3", ",", 
                    RowBox[{"24", " ", "24"}], ",", "32"}], "}"}]}], "]"}], 
                 "&"}], "/@", 
                RowBox[{"Z", "[", "1", "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"1", ",", "4"}], "}"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"ArrayReshape", "[", 
                  RowBox[{"#", ",", 
                   RowBox[{"{", 
                    RowBox[{"64", ",", 
                    RowBox[{"24", " ", "24"}]}], "}"}]}], "]"}], "&"}], "/@", 
                
                RowBox[{"e", "[", "2", "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"1", ",", "3"}], "}"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"g1", "=", 
             RowBox[{"arrayContract", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"ArrayReshape", "[", 
                  RowBox[{
                   RowBox[{"Partition", "[", 
                    RowBox[{"#", ",", 
                    RowBox[{"{", 
                    RowBox[{"26", ",", "26"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"3", ",", "3", ",", 
                    RowBox[{"26", " ", "26"}]}], "}"}]}], "]"}], "&"}], "/@", 
                
                RowBox[{"Z", "[", "0", "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"1", ",", "4"}], "}"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"ArrayReshape", "[", 
                  RowBox[{"#", ",", 
                   RowBox[{"{", 
                    RowBox[{"32", ",", 
                    RowBox[{"26", " ", "26"}]}], "}"}]}], "]"}], "&"}], "/@", 
                
                RowBox[{"e", "[", "1", "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"1", ",", "3"}], "}"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"gradQW", "[", "3", "]"}], "=", 
             RowBox[{"Transpose", "[", 
              RowBox[{"ArrayReshape", "[", 
               RowBox[{"g3", ",", 
                RowBox[{"{", 
                 RowBox[{"64", ",", "576"}], "}"}]}], "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"gradQW", "[", "2", "]"}], "=", 
             RowBox[{"Transpose", "[", 
              RowBox[{"ArrayReshape", "[", 
               RowBox[{"g2", ",", 
                RowBox[{"{", 
                 RowBox[{"64", ",", "288"}], "}"}]}], "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"gradQW", "[", "1", "]"}], "=", 
             RowBox[{"Transpose", "[", 
              RowBox[{"ArrayReshape", "[", 
               RowBox[{"g1", ",", 
                RowBox[{"{", 
                 RowBox[{"32", ",", "9"}], "}"}]}], "]"}], "]"}]}]}]}], "]"}],
          ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"epoch", ">", "10"}], ",", 
           RowBox[{"lr", "=", 
            SuperscriptBox["10", 
             RowBox[{"-", "3"}]]}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"epoch", ">", "25"}], ",", 
           RowBox[{"lr", "=", 
            SuperscriptBox["10", 
             RowBox[{"-", "4"}]]}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"Do", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"W", "[", "index", "]"}], "-=", 
            RowBox[{"lr", " ", 
             RowBox[{
              RowBox[{"gradQW", "[", "index", "]"}], "/", "nBatch"}]}]}], ",", 
           RowBox[{"{", 
            RowBox[{"index", ",", "Windices"}], "}"}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"Do", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"b", "[", "index", "]"}], "-=", 
            RowBox[{"lr", " ", 
             RowBox[{
              RowBox[{"gradQb", "[", "index", "]"}], "/", "nBatch"}]}]}], ",", 
           RowBox[{"{", 
            RowBox[{"index", ",", "bindices"}], "}"}]}], "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"p", ",", "nBatches"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"preds", "=", 
       RowBox[{"batchPred", "[", "data", "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{
       RowBox[{"matches", "[", "epoch", "]"}], "=", 
       RowBox[{"MapThread", "[", 
        RowBox[{"Equal", ",", 
         RowBox[{"{", 
          RowBox[{"preds", ",", "labels"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"correct", "[", "epoch", "]"}], "=", 
       RowBox[{"Count", "[", 
        RowBox[{
         RowBox[{"matches", "[", "epoch", "]"}], ",", "True"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"acc", "[", "epoch", "]"}], "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"correct", "[", "epoch", "]"}], "/", "nTrain"}], "]"}]}], ";",
       "\[IndentingNewLine]", 
      RowBox[{"preds", "=", 
       RowBox[{"batchPred", "[", "testData", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"testMatches", "[", "epoch", "]"}], "=", 
       RowBox[{"MapThread", "[", 
        RowBox[{"Equal", ",", 
         RowBox[{"{", 
          RowBox[{"preds", ",", "testLabels"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"testCorrect", "[", "epoch", "]"}], "=", 
       RowBox[{"Count", "[", 
        RowBox[{
         RowBox[{"testMatches", "[", "epoch", "]"}], ",", "True"}], "]"}]}], ";",
       "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"testAcc", "[", "epoch", "]"}], "=", 
       RowBox[{"N", "[", 
        RowBox[{
         RowBox[{"testCorrect", "[", "epoch", "]"}], "/", "nTest"}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"Print", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"correct", "[", "epoch", "]"}], ",", 
         RowBox[{"acc", "[", "epoch", "]"}], ",", 
         RowBox[{"testCorrect", "[", "epoch", "]"}], ",", 
         RowBox[{"testAcc", "[", "epoch", "]"}]}], "}"}], "]"}]}], ",", 
     RowBox[{"{", 
      RowBox[{"epoch", ",", "epochs"}], "}"}]}], "]"}], ",", 
   RowBox[{"{", 
    RowBox[{"epoch", ",", "epochs", ",", "p", ",", "nBatches"}], "}"}]}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.976282010387782*^9, 3.976282045867313*^9}, {
   3.9762821725498323`*^9, 3.976282173130726*^9}, {3.976282207427511*^9, 
   3.976282211966185*^9}, {3.9762976885370483`*^9, 3.976297689093498*^9}, {
   3.976297835975016*^9, 3.9762978412962914`*^9}, 3.9763729879313517`*^9, {
   3.976373132495528*^9, 3.976373187914403*^9}, {3.976373397712057*^9, 
   3.976373414088767*^9}, {3.976416000053316*^9, 3.976416091741769*^9}, {
   3.976416844664576*^9, 3.9764169237714167`*^9}, 3.976417057368649*^9, 
   3.976417178311178*^9, {3.97641722389743*^9, 3.976417228650337*^9}, {
   3.976417269029767*^9, 3.9764173265167437`*^9}, {3.9764176374946957`*^9, 
   3.976417669589562*^9}, {3.976417756730783*^9, 3.976417768217499*^9}, {
   3.976417809501273*^9, 3.976417810464615*^9}, {3.976421951611607*^9, 
   3.9764219550825567`*^9}, {3.976421990449849*^9, 3.976422016964875*^9}, {
   3.9764220687806063`*^9, 3.976422068996552*^9}, 3.9764221119254847`*^9, {
   3.9764547015444508`*^9, 3.976454703464048*^9}, {3.976454942058033*^9, 
   3.976454992220396*^9}, {3.976462001508045*^9, 3.976462001924983*^9}, 
   3.9764636638035927`*^9, 3.976483568348547*^9, {3.9764889197106647`*^9, 
   3.97648892494339*^9}, {3.9765767530462914`*^9, 3.976576959136168*^9}, {
   3.976577098370427*^9, 3.976577131694989*^9}, {3.976755233405678*^9, 
   3.976755244514045*^9}, {3.976755284224813*^9, 3.976755302728032*^9}, {
   3.97684158157096*^9, 3.9768415819358673`*^9}, {3.976914437289686*^9, 
   3.9769144538853483`*^9}, {3.9769147582019653`*^9, 3.97691478246035*^9}, {
   3.976919886006239*^9, 3.976919899446999*^9}},
 CellLabel->
  "In[249]:=",ExpressionUUID->"f0c53fcb-3aac-4338-bf35-6134b429439f"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"shuffle", "=", 
       RowBox[{"Partition", "[", 
        RowBox[{
         RowBox[{"RandomSample", "[", 
          RowBox[{"Range", "[", "nTrain", "]"}], "]"}], ",", 
         RowBox[{"UpTo", "[", "batchSize", "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"batch", "=", 
       RowBox[{"shuffle", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"nBatch", "=", 
       RowBox[{"Length", "[", "batch", "]"}]}], ";"}], "\[IndentingNewLine]", 
     "start"}], "=", 
    RowBox[{"now", "=", 
     RowBox[{"SessionTime", "[", "]"}]}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"constructedW", "[", "3", "]"}], "=", 
    RowBox[{"ArrayReshape", "[", 
     RowBox[{
      RowBox[{"Transpose", "[", 
       RowBox[{
        RowBox[{"Reverse", "[", 
         RowBox[{"ArrayReshape", "[", 
          RowBox[{
           RowBox[{"W", "[", "3", "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"9", ",", "64", ",", "64"}], "}"}]}], "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "3", ",", "2"}], "}"}]}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"576", ",", "64"}], "}"}]}], "]"}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"constructedW", "[", "2", "]"}], "=", 
    RowBox[{"ArrayReshape", "[", 
     RowBox[{
      RowBox[{"Transpose", "[", 
       RowBox[{
        RowBox[{"Reverse", "[", 
         RowBox[{"ArrayReshape", "[", 
          RowBox[{
           RowBox[{"W", "[", "2", "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"9", ",", "32", ",", "64"}], "}"}]}], "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "3", ",", "2"}], "}"}]}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"576", ",", "32"}], "}"}]}], "]"}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Z", "[", "0", "]"}], "=", 
    RowBox[{"data", "[", 
     RowBox[{"[", "batch", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{"rVec", "=", 
    RowBox[{"pos", "/@", 
     RowBox[{"labels", "[", 
      RowBox[{"[", "batch", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Print", "[", 
      RowBox[{"\"\<setup \>\"", ",", 
       RowBox[{
        RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]",
      "now"}], "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"A", "[", "1", "]"}], "=", 
    RowBox[{"Dot", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"ArrayReshape", "[", 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"26", ",", "26", ",", 
            RowBox[{"3", " ", "3"}]}], "}"}]}], "]"}], "&"}], "/@", 
       RowBox[{"Z", "[", "0", "]"}]}], ",", 
      RowBox[{"W", "[", "1", "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Z", "[", "1", "]"}], "=", 
    RowBox[{"Ramp", "[", 
     RowBox[{"A", "[", "1", "]"}], "]"}]}], ";", "\n", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<1 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"A", "[", "2", "]"}], "=", 
    RowBox[{"Dot", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"ArrayReshape", "[", 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"24", ",", "24", ",", 
            RowBox[{"3", " ", "3", " ", "32"}]}], "}"}]}], "]"}], "&"}], "/@", 
       RowBox[{"Z", "[", "1", "]"}]}], ",", 
      RowBox[{"W", "[", "2", "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Z", "[", "2", "]"}], "=", 
    RowBox[{"Ramp", "[", 
     RowBox[{"A", "[", "2", "]"}], "]"}]}], ";", "\n", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<2 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"A", "[", "3", "]"}], "=", 
    RowBox[{"Dot", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"ArrayReshape", "[", 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{"3", ",", "3"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"22", ",", "22", ",", 
            RowBox[{"3", " ", "3", " ", "64"}]}], "}"}]}], "]"}], "&"}], "/@", 
       RowBox[{"Z", "[", "2", "]"}]}], ",", 
      RowBox[{"W", "[", "3", "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Z", "[", "3", "]"}], "=", 
    RowBox[{"Ramp", "[", 
     RowBox[{"A", "[", "3", "]"}], "]"}]}], ";", "\n", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<3 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"A", "[", "4", "]"}], "=", 
    RowBox[{"Transpose", "[", 
     RowBox[{
      RowBox[{"maxpool", "[", 
       RowBox[{
        RowBox[{"Z", "[", "3", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "2", ",", "2", ",", "1"}], "}"}]}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "3", ",", "4", ",", "2"}], "}"}]}], "]"}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Z", "[", "4", "]"}], "=", 
    RowBox[{"Flatten", "/@", 
     RowBox[{"A", "[", "4", "]"}]}]}], ";", "\n", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<4 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"A", "[", "5", "]"}], "=", 
    RowBox[{
     RowBox[{
      RowBox[{"#", "+", 
       RowBox[{"b", "[", "5", "]"}]}], "&"}], "/@", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"Z", "[", "4", "]"}], ".", 
       RowBox[{"Transpose", "[", 
        RowBox[{"W", "[", "5", "]"}], "]"}]}], ")"}]}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Z", "[", "5", "]"}], "=", 
    RowBox[{"Ramp", "[", 
     RowBox[{"A", "[", "5", "]"}], "]"}]}], ";", "\n", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<5 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"A", "[", "6", "]"}], "=", 
    RowBox[{
     RowBox[{
      RowBox[{"#", "+", 
       RowBox[{"b", "[", "6", "]"}]}], "&"}], "/@", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"Z", "[", "5", "]"}], ".", 
       RowBox[{"Transpose", "[", 
        RowBox[{"W", "[", "6", "]"}], "]"}]}], ")"}]}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Z", "[", "6", "]"}], "=", 
    RowBox[{"Ramp", "[", 
     RowBox[{"A", "[", "6", "]"}], "]"}]}], ";", "\n", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<6 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"A", "[", "7", "]"}], "=", 
    RowBox[{
     RowBox[{
      RowBox[{"#", "+", 
       RowBox[{"b", "[", "7", "]"}]}], "&"}], "/@", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"Z", "[", "6", "]"}], ".", 
       RowBox[{"Transpose", "[", 
        RowBox[{"W", "[", "7", "]"}], "]"}]}], ")"}]}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"y", "=", 
    RowBox[{"Exp", "[", 
     RowBox[{"A", "[", "7", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{"y", "=", 
    RowBox[{"y", "/", 
     RowBox[{"(", 
      RowBox[{"Total", "/@", "y"}], ")"}]}]}], ";", "\[IndentingNewLine]", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<pred \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{"labelMat", "=", 
    RowBox[{
     RowBox[{
      RowBox[{"UnitVector", "[", 
       RowBox[{"nClasses", ",", "#"}], "]"}], "&"}], "/@", "rVec"}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"e", "[", "7", "]"}], "=", 
    RowBox[{"y", "-", "labelMat"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<b7 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{"Do", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"e", "[", "j", "]"}], "=", 
      RowBox[{
       RowBox[{
        RowBox[{"e", "[", 
         RowBox[{"j", "+", "1"}], "]"}], ".", 
        RowBox[{"W", "[", 
         RowBox[{"j", "+", "1"}], "]"}]}], 
       RowBox[{"Unitize", "[", 
        RowBox[{"Z", "[", "j", "]"}], "]"}]}]}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "6", ",", "5", ",", 
       RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"e", "[", "4", "]"}], "=", 
    RowBox[{
     RowBox[{"e", "[", "5", "]"}], ".", 
     RowBox[{"W", "[", "5", "]"}]}]}], ";", "\[IndentingNewLine]", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<b654 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"e", "[", "3", "]"}], "=", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{"Transpose", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"maxpoolD", "[", 
          RowBox[{
           RowBox[{"Z", "[", "3", "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"1", ",", "2", ",", "2", ",", "1"}], "}"}]}], "]"}], 
         RowBox[{"Unitize", "[", 
          RowBox[{"Z", "[", "3", "]"}], "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "3", ",", "4", ",", "2"}], "}"}]}], "]"}], ")"}], 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"KroneckerProduct", "[", 
           RowBox[{"#", ",", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"1.", ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "2"}], "}"}]}], "]"}]}], "]"}], "&"}], "/@", 
         
         RowBox[{"ArrayReshape", "[", 
          RowBox[{"#", ",", 
           RowBox[{"{", 
            RowBox[{"64", ",", "11", ",", "11"}], "}"}]}], "]"}]}], "&"}], "/@", 
       RowBox[{"e", "[", "4", "]"}]}], ")"}]}]}], ";", "\[IndentingNewLine]", 
   
   RowBox[{"Print", "[", 
    RowBox[{"\"\<b3 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"e", "[", "2", "]"}], "=", 
    RowBox[{"Transpose", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"Map", "[", 
         RowBox[{"Flatten", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"Partition", "[", 
             RowBox[{"#", ",", 
              RowBox[{"{", 
               RowBox[{"3", ",", "3"}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"1", ",", "1"}], "}"}]}], "]"}], "&"}], "/@", 
           RowBox[{"Transpose", "[", 
            RowBox[{
             RowBox[{"ArrayPad", "[", 
              RowBox[{
               RowBox[{"e", "[", "3", "]"}], ",", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"0", ",", "0"}], "}"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"0", ",", "0"}], "}"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"2", ",", "2"}], "}"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"2", ",", "2"}], "}"}]}], "}"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"1", ",", "4", ",", "2", ",", "3"}], "}"}]}], "]"}]}], ",", 
          RowBox[{"{", "3", "}"}]}], "]"}], ".", 
        RowBox[{"constructedW", "[", "3", "]"}]}], " ", 
       RowBox[{"Unitize", "[", 
        RowBox[{"Z", "[", "2", "]"}], "]"}]}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "3", ",", "4", ",", "2"}], "}"}]}], "]"}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<b2 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"e", "[", "1", "]"}], "=", 
    RowBox[{"Transpose", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"Map", "[", 
         RowBox[{"Flatten", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"Partition", "[", 
             RowBox[{"#", ",", 
              RowBox[{"{", 
               RowBox[{"3", ",", "3"}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"1", ",", "1"}], "}"}]}], "]"}], "&"}], "/@", 
           RowBox[{"Transpose", "[", 
            RowBox[{
             RowBox[{"ArrayPad", "[", 
              RowBox[{
               RowBox[{"e", "[", "2", "]"}], ",", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"0", ",", "0"}], "}"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"0", ",", "0"}], "}"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"2", ",", "2"}], "}"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"2", ",", "2"}], "}"}]}], "}"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"1", ",", "4", ",", "2", ",", "3"}], "}"}]}], "]"}]}], ",", 
          RowBox[{"{", "3", "}"}]}], "]"}], ".", 
        RowBox[{"constructedW", "[", "2", "]"}]}], " ", 
       RowBox[{"Unitize", "[", 
        RowBox[{"Z", "[", "1", "]"}], "]"}]}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "3", ",", "4", ",", "2"}], "}"}]}], "]"}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<b1 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Do", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"gradQW", "[", "j", "]"}], "=", 
        RowBox[{
         RowBox[{"Transpose", "[", 
          RowBox[{"e", "[", "j", "]"}], "]"}], ".", 
         RowBox[{"Z", "[", 
          RowBox[{"j", "-", "1"}], "]"}]}]}], ";", 
       RowBox[{
        RowBox[{"gradQb", "[", "j", "]"}], "=", 
        RowBox[{"Total", "[", 
         RowBox[{"e", "[", "j", "]"}], "]"}]}]}], ",", 
      RowBox[{"{", 
       RowBox[{"j", ",", "5", ",", "7"}], "}"}]}], "]"}], "\[IndentingNewLine]", 
    RowBox[{"Print", "[", 
     RowBox[{"\"\<w567 \>\"", ",", 
      RowBox[{
       RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"gradQW", "[", "3", "]"}], "=", 
    RowBox[{"arrayContract", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"ArrayReshape", "[", 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{"22", ",", "22"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"3", ",", "3", ",", 
            RowBox[{"22", " ", "22"}], ",", "64"}], "}"}]}], "]"}], "&"}], "/@", 
       RowBox[{"Z", "[", "2", "]"}]}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "4"}], "}"}], ",", 
      RowBox[{
       RowBox[{
        RowBox[{"ArrayReshape", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{"64", ",", 
            RowBox[{"22", " ", "22"}]}], "}"}]}], "]"}], "&"}], "/@", 
       RowBox[{"e", "[", "3", "]"}]}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "3"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
   
   RowBox[{"Print", "[", 
    RowBox[{"\"\<w3 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"gradQW", "[", "2", "]"}], "=", 
    RowBox[{"arrayContract", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"ArrayReshape", "[", 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{"24", ",", "24"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"3", ",", "3", ",", 
            RowBox[{"24", " ", "24"}], ",", "32"}], "}"}]}], "]"}], "&"}], "/@", 
       RowBox[{"Z", "[", "1", "]"}]}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "4"}], "}"}], ",", 
      RowBox[{
       RowBox[{
        RowBox[{"ArrayReshape", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{"64", ",", 
            RowBox[{"24", " ", "24"}]}], "}"}]}], "]"}], "&"}], "/@", 
       RowBox[{"e", "[", "2", "]"}]}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "3"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
   
   RowBox[{"Print", "[", 
    RowBox[{"\"\<w2 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"gradQW", "[", "1", "]"}], "=", 
    RowBox[{"arrayContract", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"ArrayReshape", "[", 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{"26", ",", "26"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"1", ",", "1"}], "}"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"3", ",", "3", ",", 
            RowBox[{"26", " ", "26"}]}], "}"}]}], "]"}], "&"}], "/@", 
       RowBox[{"Z", "[", "0", "]"}]}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "4"}], "}"}], ",", 
      RowBox[{
       RowBox[{
        RowBox[{"ArrayReshape", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{"32", ",", 
            RowBox[{"26", " ", "26"}]}], "}"}]}], "]"}], "&"}], "/@", 
       RowBox[{"e", "[", "1", "]"}]}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "3"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
   
   RowBox[{"Print", "[", 
    RowBox[{"\"\<w1 \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"gradQW", "[", "3", "]"}], "=", 
    RowBox[{"ArrayReshape", "[", 
     RowBox[{
      RowBox[{"gradQW", "[", "3", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"576", ",", "64"}], "}"}]}], "]"}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"gradQW", "[", "2", "]"}], "=", 
    RowBox[{"ArrayReshape", "[", 
     RowBox[{
      RowBox[{"gradQW", "[", "2", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"288", ",", "64"}], "}"}]}], "]"}]}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"gradQW", "[", "1", "]"}], "=", 
    RowBox[{"ArrayReshape", "[", 
     RowBox[{
      RowBox[{"gradQW", "[", "1", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"9", ",", "32"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<end \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{"Print", "[", 
    RowBox[{"\"\<total \>\"", ",", 
     RowBox[{
      RowBox[{"SessionTime", "[", "]"}], "-", "start"}]}], "]"}], ";"}], 
  "*)"}]], "Input",
 CellChangeTimes->{{3.976231061055578*^9, 3.97623108285287*^9}, {
   3.97623220302883*^9, 3.976232209464281*^9}, {3.976237320041429*^9, 
   3.976237349017597*^9}, {3.9762395995500107`*^9, 3.976239623594549*^9}, {
   3.9762396653753757`*^9, 3.976239862842849*^9}, {3.976241401200964*^9, 
   3.9762414328846684`*^9}, {3.976241494639925*^9, 3.97624149599325*^9}, {
   3.976241616063921*^9, 3.9762416281120987`*^9}, {3.976241728387857*^9, 
   3.976241728526182*^9}, {3.976241760595976*^9, 3.97624176597969*^9}, {
   3.97624191199116*^9, 3.9762420016571198`*^9}, {3.976242380846653*^9, 
   3.976242396501152*^9}, {3.976243090097048*^9, 3.976243094674457*^9}, {
   3.976245373873269*^9, 3.976245390938095*^9}, {3.976245464027341*^9, 
   3.9762454665298243`*^9}, {3.976245521932541*^9, 3.976245523581923*^9}, {
   3.976246708087772*^9, 3.976246714123077*^9}, {3.976247608730494*^9, 
   3.976247609040072*^9}, {3.9762477198395576`*^9, 3.9762477405994577`*^9}, {
   3.976247911319607*^9, 3.97624792402452*^9}, {3.976248038612817*^9, 
   3.976248083276375*^9}, {3.9762481466019773`*^9, 3.976248183608138*^9}, 
   3.976282055449154*^9, {3.976401305566135*^9, 3.976401337841902*^9}, {
   3.976401377374655*^9, 3.976401387210253*^9}, {3.976403103431591*^9, 
   3.976403116316177*^9}, {3.976403160649074*^9, 3.976403163541719*^9}, {
   3.976403246271689*^9, 3.976403265528426*^9}, {3.976403810721697*^9, 
   3.976403830939258*^9}, 3.976403933217651*^9, 3.97640644188524*^9, {
   3.976406485104616*^9, 3.976406488382886*^9}, 3.976408263689147*^9, {
   3.976410045341322*^9, 3.9764100504714537`*^9}, {3.976410133382524*^9, 
   3.9764101719781847`*^9}, {3.976410238136549*^9, 3.9764102420192204`*^9}, {
   3.976410402104192*^9, 3.976410424976885*^9}, {3.976410752882819*^9, 
   3.97641082061648*^9}, {3.9764110131618967`*^9, 3.976411014798448*^9}, {
   3.9764110868303328`*^9, 3.9764111359310102`*^9}, {3.976411559456237*^9, 
   3.976411580397151*^9}, {3.976413056002102*^9, 3.976413065312676*^9}, 
   3.9764133164610157`*^9, {3.976416554581171*^9, 3.976416563653557*^9}, 
   3.976416652293208*^9, 3.976416770708338*^9, {3.9764173865273027`*^9, 
   3.976417387120769*^9}, {3.976417596949581*^9, 3.976417614273213*^9}, {
   3.976543687610664*^9, 3.976543704945674*^9}, {3.9765440120241623`*^9, 
   3.976544026108757*^9}, {3.9765440613376637`*^9, 3.9765441366796207`*^9}, {
   3.97654419572045*^9, 3.976544263711568*^9}, 3.9765442954351892`*^9, {
   3.97654433752916*^9, 3.976544339412364*^9}, {3.976544875932687*^9, 
   3.976544927337619*^9}, {3.97654501829384*^9, 3.976545025112214*^9}, {
   3.976545235822851*^9, 3.9765452599749537`*^9}, {3.976545743574196*^9, 
   3.976545748408306*^9}, {3.9765460316982613`*^9, 3.976546054816209*^9}, {
   3.976546182447504*^9, 3.976546212770131*^9}, {3.976546753707623*^9, 
   3.97654683712184*^9}, 3.976546867255477*^9, 3.976547011315629*^9, {
   3.976551005491582*^9, 3.976551015995368*^9}, {3.976573064183415*^9, 
   3.976573064334463*^9}, {3.976576667075197*^9, 3.976576671064763*^9}, {
   3.9769153086483603`*^9, 
   3.976915523273059*^9}},ExpressionUUID->"d21dae8e-6bda-4055-a0f5-\
a10d1f56a97c"]
},
WindowSize->{864, 1051},
WindowMargins->{{0, Automatic}, {Automatic, 0}},
FrontEndVersion->"14.3 for Mac OS X ARM (64-bit) (July 8, 2025)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"0543f059-a012-4b6c-8655-c9482b1d85bf"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[554, 20, 2046, 57, 151, "Input",ExpressionUUID->"3792c392-85da-43c8-ac61-496cc33e45cb"],
Cell[2603, 79, 2050, 52, 192, "Input",ExpressionUUID->"d0e49f47-63b3-45bb-9bf8-629ef2ddde03"],
Cell[4656, 133, 8403, 208, 745, "Input",ExpressionUUID->"fca58653-f31e-4634-847c-0491020d8cbf"],
Cell[13062, 343, 2072, 41, 90, "Input",ExpressionUUID->"3b5522d1-65d1-4059-9504-0c75cec02f1c"],
Cell[15137, 386, 7217, 218, 368, "Input",ExpressionUUID->"4146b0e3-987e-4d00-b898-476541cd0796"],
Cell[22357, 606, 12325, 330, 764, "Input",ExpressionUUID->"9894ce5b-4ff8-4f50-9fb9-f10d2703670c"],
Cell[34685, 938, 1032, 26, 90, "Input",ExpressionUUID->"13faf20f-1b8f-4e15-81a3-781474368cf1"],
Cell[35720, 966, 26140, 626, 1393, "Input",ExpressionUUID->"f0c53fcb-3aac-4338-bf35-6134b429439f"],
Cell[61863, 1594, 24390, 649, 1765, "Input",ExpressionUUID->"d21dae8e-6bda-4055-a0f5-a10d1f56a97c"]
}
]
*)

