(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Wolfram 14.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       154,          7]
NotebookDataLength[     90631,       2455]
NotebookOptionsPosition[     89302,       2431]
NotebookOutlinePosition[     89694,       2447]
CellTagsIndexPosition[     89651,       2444]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{"mnist", "=", 
   RowBox[{"ResourceData", "[", 
    RowBox[{"\"\<MNIST\>\"", ",", "\"\<TrainingData\>\""}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"mnistTest", "=", 
   RowBox[{"ResourceData", "[", 
    RowBox[{"\"\<MNIST\>\"", ",", "\"\<TestData\>\""}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"group", "[", "i_", "]"}], ":=", 
  RowBox[{
   RowBox[{"group", "[", "i", "]"}], "=", 
   RowBox[{
    RowBox[{"Select", "[", 
     RowBox[{"mnist", ",", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "==", "i"}], "&"}]}], "]"}], "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"trainSize", "[", "i_", "]"}], ":=", 
  RowBox[{
   RowBox[{"trainSize", "[", "i", "]"}], "=", 
   RowBox[{"Length", "[", 
    RowBox[{"group", "[", "i", "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"groupTest", "[", "i_", "]"}], ":=", 
  RowBox[{
   RowBox[{"groupTest", "[", "i", "]"}], "=", 
   RowBox[{
    RowBox[{"Select", "[", 
     RowBox[{"mnistTest", ",", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "==", "i"}], "&"}]}], "]"}], "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testSize", "[", "i_", "]"}], ":=", 
  RowBox[{
   RowBox[{"testSize", "[", "i", "]"}], "=", 
   RowBox[{"Length", "[", 
    RowBox[{"groupTest", "[", "i", "]"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"vec", "[", "img_", "]"}], ":=", 
  RowBox[{"1", "-", 
   RowBox[{"Flatten", "[", 
    RowBox[{"ImageData", "[", "img", "]"}], 
    "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"mat", "[", "img_", "]"}], ":=", 
  RowBox[{"1", "-", 
   RowBox[{"ImageData", "[", "img", "]"}]}]}]}], "Input",
 CellChangeTimes->{{3.9750268793331203`*^9, 3.9750269215800047`*^9}, 
   3.976100003828727*^9, {3.976100034640066*^9, 3.976100060391409*^9}, 
   3.976100661069633*^9, {3.9762038833538027`*^9, 3.976203888807516*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"12b745ba-6c5a-4023-8ad9-9da76874d8e2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"data", "=", 
   RowBox[{"mat", "/@", 
    RowBox[{"mnist", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"labels", "=", 
   RowBox[{"mnist", "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "2"}], "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testData", "=", 
   RowBox[{"mat", "/@", 
    RowBox[{"mnistTest", "[", 
     RowBox[{"[", 
      RowBox[{"All", ",", "1"}], "]"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testLabels", "=", 
   RowBox[{"mnistTest", "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "2"}], "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nTrain", "=", 
   RowBox[{"Length", "[", "labels", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nTest", "=", 
   RowBox[{"Length", "[", "testLabels", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"classes", "=", 
   RowBox[{"DeleteDuplicates", "[", "labels", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nClasses", "=", 
   RowBox[{"Length", "[", "classes", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pos", "=", 
   RowBox[{"AssociationThread", "[", 
    RowBox[{"classes", "->", 
     RowBox[{"Range", "[", "nClasses", "]"}]}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.976100598959671*^9, 3.976100620354196*^9}, {
   3.976100950457341*^9, 3.976100956921783*^9}, {3.976101075995407*^9, 
   3.976101109167481*^9}, {3.9761013662430887`*^9, 3.97610140233617*^9}, {
   3.9761056183741293`*^9, 3.97610562880655*^9}, {3.976105662871686*^9, 
   3.976105670539914*^9}, 3.976123547629385*^9, {3.976229591247658*^9, 
   3.9762296109448767`*^9}, {3.9762296433188877`*^9, 3.976229662995109*^9}},
 CellLabel->"In[9]:=",ExpressionUUID->"13662720-b09d-43cb-a136-01a86310efc1"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"convolutionProduct", "[", 
   RowBox[{"matrix_", ",", "kernel_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"k", ",", "l", ",", "m", ",", "n", ",", "newMatrix"}], "}"}], ",",
     "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"k", ",", "l"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "matrix", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"m", ",", "n"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "kernel", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"newMatrix", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"0.", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"k", "-", "m", "+", "1"}], ",", 
          RowBox[{"l", "-", "n", "+", "1"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{"newMatrix", "+=", 
        RowBox[{
         RowBox[{"kernel", "[", 
          RowBox[{"[", 
           RowBox[{"i", ",", "j"}], "]"}], "]"}], 
         RowBox[{"matrix", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"i", ";;", 
             RowBox[{"k", "-", "m", "+", "i"}]}], ",", 
            RowBox[{"j", ";;", 
             RowBox[{"l", "-", "n", "+", "j"}]}]}], "]"}], "]"}]}]}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "m"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "n"}], "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
     "newMatrix"}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"correlationProduct", "[", 
   RowBox[{"matrix_", ",", "kernel_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"k", ",", "l", ",", "m", ",", "n", ",", "newMatrix"}], "}"}], ",",
     "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"k", ",", "l"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "matrix", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"m", ",", "n"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "kernel", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"newMatrix", "=", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"0.", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"k", "-", "m", "+", "1"}], ",", 
          RowBox[{"l", "-", "n", "+", "1"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{"newMatrix", "+=", 
        RowBox[{
         RowBox[{"kernel", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"m", "-", "i", "+", "1"}], ",", 
            RowBox[{"n", "-", "j", "+", "1"}]}], "]"}], "]"}], 
         RowBox[{"matrix", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"i", ";;", 
             RowBox[{"k", "-", "m", "+", "i"}]}], ",", 
            RowBox[{"j", ";;", 
             RowBox[{"l", "-", "n", "+", "j"}]}]}], "]"}], "]"}]}]}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "m"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "n"}], "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
     "newMatrix"}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"convolutionProduct2", "[", 
   RowBox[{"matrix_", ",", "kernel_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"k", ",", "l", ",", "m", ",", "n"}], "}"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"k", ",", "l"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "matrix", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"m", ",", "n"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", "kernel", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"Total", "[", 
        RowBox[{
         RowBox[{"kernel", " ", 
          RowBox[{"matrix", "[", 
           RowBox[{"[", 
            RowBox[{
             RowBox[{"i", ";;", 
              RowBox[{"i", "+", "m", "-", "1"}]}], ",", 
             RowBox[{"j", ";;", 
              RowBox[{"j", "+", "n", "-", "1"}]}]}], "]"}], "]"}]}], ",", 
         "2"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", 
         RowBox[{"k", "-", "m", "+", "1"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", 
         RowBox[{"l", "-", "n", "+", "1"}]}], "}"}]}], "]"}]}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"maxpool", "[", 
   RowBox[{"array_", ",", "spec_"}], "]"}], ":=", 
  RowBox[{"Map", "[", 
   RowBox[{"Max", ",", 
    RowBox[{"Partition", "[", 
     RowBox[{"array", ",", 
      RowBox[{"UpTo", "/@", 
       RowBox[{"Flatten", "[", 
        RowBox[{"{", "spec", "}"}], "]"}]}]}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"Max", "[", 
      RowBox[{
       RowBox[{"Length", "[", "spec", "]"}], ",", "1"}], "]"}], "}"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"maxpoolD", "[", 
   RowBox[{"array_", ",", "spec_"}], "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"pooled", "=", 
       RowBox[{"maxpool", "[", 
        RowBox[{"array", ",", "spec"}], "]"}]}], ",", "empty"}], "}"}], ",", 
    RowBox[{"ArrayFlatten", "[", 
     RowBox[{
      RowBox[{"MapThread", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"dims", "=", 
            RowBox[{"Dimensions", "[", "#1", "]"}]}], ";", 
           RowBox[{"fp", "=", 
            RowBox[{"FirstPosition", "[", 
             RowBox[{"#1", ",", "#2"}], "]"}]}], ";", 
           RowBox[{"empty", "=", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"0", ",", "dims"}], "]"}]}], ";", 
           RowBox[{
            RowBox[{"empty", "[", 
             RowBox[{"[", 
              RowBox[{"Sequence", "@@", "fp"}], "]"}], "]"}], "=", "1"}], ";",
            "empty"}], ")"}], "&"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"array", ",", 
            RowBox[{"UpTo", "/@", 
             RowBox[{"Flatten", "[", 
              RowBox[{"{", "spec", "}"}], "]"}]}]}], "]"}], ",", "pooled"}], 
         "}"}], ",", 
        RowBox[{"Max", "[", 
         RowBox[{
          RowBox[{"Length", "[", "spec", "]"}], ",", "1"}], "]"}]}], "]"}], ",", 
      RowBox[{"Max", "[", 
       RowBox[{
        RowBox[{"Length", "[", "spec", "]"}], ",", "1"}], "]"}]}], "]"}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.976221315309025*^9, 3.976221344504764*^9}, 
   3.9762214350141487`*^9, {3.976225065856852*^9, 3.976225066041827*^9}, {
   3.9762250983322163`*^9, 3.976225116553341*^9}, {3.97622853211406*^9, 
   3.976228539599065*^9}, {3.976228681096571*^9, 3.97622868249146*^9}, {
   3.976229272208712*^9, 3.976229275436349*^9}, {3.9762338804869328`*^9, 
   3.976233954790728*^9}, {3.976234205389256*^9, 3.976234224856764*^9}, 
   3.976234270891054*^9, {3.9762343206183043`*^9, 3.976234321010861*^9}, {
   3.9762410814610662`*^9, 3.976241084049829*^9}, {3.9762450128353167`*^9, 
   3.97624516967654*^9}, {3.976245262963437*^9, 3.9762452703252077`*^9}, {
   3.976245679465605*^9, 3.976245700193479*^9}, {3.976282360244246*^9, 
   3.976282360865932*^9}},
 CellLabel->"In[18]:=",ExpressionUUID->"fca58653-f31e-4634-847c-0491020d8cbf"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"batchSize", "=", "512"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"updateFrequency", "=", "1"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"lr", "=", 
   SuperscriptBox["10", 
    RowBox[{"-", "1"}]]}], ";"}]}], "Input",
 CellChangeTimes->{{3.9762980640396442`*^9, 3.976298064183342*^9}, {
  3.976327858300624*^9, 3.97632785845047*^9}, {3.976331262459462*^9, 
  3.976331262691091*^9}},
 CellLabel->"In[23]:=",ExpressionUUID->"3b5522d1-65d1-4059-9504-0c75cec02f1c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "1", "]"}], "=", 
   RowBox[{
    RowBox[{"RandomVariate", "[", 
     RowBox[{
      RowBox[{"NormalDistribution", "[", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"32", ",", "3", ",", "3"}], "}"}]}], "]"}], 
    SqrtBox[
     RowBox[{"2.", "/", 
      RowBox[{"(", 
       RowBox[{"3", " ", "3"}], ")"}]}]]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "2", "]"}], "=", 
   RowBox[{
    RowBox[{"RandomVariate", "[", 
     RowBox[{
      RowBox[{"NormalDistribution", "[", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"64", ",", "32", ",", "3", ",", "3"}], "}"}]}], "]"}], 
    SqrtBox[
     RowBox[{"2.", "/", 
      RowBox[{"(", 
       RowBox[{"3", " ", "3", " ", "32"}], ")"}]}]]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "3", "]"}], "=", 
   RowBox[{
    RowBox[{"RandomVariate", "[", 
     RowBox[{
      RowBox[{"NormalDistribution", "[", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"64", ",", "64", ",", "3", ",", "3"}], "}"}]}], "]"}], 
    SqrtBox[
     RowBox[{"2.", "/", 
      RowBox[{"(", 
       RowBox[{"3", " ", "3", " ", "64"}], ")"}]}]]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "5", "]"}], "=", 
   RowBox[{
    RowBox[{"RandomVariate", "[", 
     RowBox[{
      RowBox[{"NormalDistribution", "[", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"7744", ",", "7744"}], "}"}]}], "]"}], 
    SqrtBox[
     RowBox[{"2.", "/", "7744"}]]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"b", "[", "5", "]"}], "=", 
   RowBox[{"ConstantArray", "[", 
    RowBox[{"0.", ",", "7744"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "6", "]"}], "=", 
   RowBox[{
    RowBox[{"RandomVariate", "[", 
     RowBox[{
      RowBox[{"NormalDistribution", "[", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"128", ",", "7744"}], "}"}]}], "]"}], 
    SqrtBox[
     RowBox[{"2.", "/", "7744"}]]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"b", "[", "6", "]"}], "=", 
   RowBox[{"ConstantArray", "[", 
    RowBox[{"0.", ",", "128"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", "7", "]"}], "=", 
   RowBox[{
    RowBox[{"RandomVariate", "[", 
     RowBox[{
      RowBox[{"NormalDistribution", "[", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"10", ",", "128"}], "}"}]}], "]"}], 
    SqrtBox[
     RowBox[{"2.", "/", "128"}]]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"b", "[", "7", "]"}], "=", 
   RowBox[{"ConstantArray", "[", 
    RowBox[{"0.", ",", "10"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Windices", "=", 
   RowBox[{"{", 
    RowBox[{"1", ",", "2", ",", "3", ",", "5", ",", "6", ",", "7"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"bindices", "=", 
   RowBox[{"{", 
    RowBox[{"5", ",", "6", ",", "7"}], "}"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.976223638554644*^9, 3.976223678123293*^9}, {
  3.976223712664399*^9, 3.976223728568542*^9}, {3.9762239590497923`*^9, 
  3.9762239749515343`*^9}, {3.976224007762219*^9, 3.976224007802857*^9}, {
  3.9762242875780907`*^9, 3.976224304767605*^9}, {3.976224470455221*^9, 
  3.976224488019503*^9}, {3.9762252774997797`*^9, 3.976225284458849*^9}, {
  3.976225324662086*^9, 3.9762253560197573`*^9}, {3.976225388829075*^9, 
  3.976225409335413*^9}, {3.9762254436809053`*^9, 3.976225508850383*^9}, {
  3.9762264727792664`*^9, 3.976226539659336*^9}, {3.976226583583222*^9, 
  3.976226587389333*^9}, {3.976226648066868*^9, 3.976226656845935*^9}, {
  3.9762303277327013`*^9, 3.976230344186852*^9}, {3.976246937503549*^9, 
  3.9762469644263477`*^9}, {3.976247007022784*^9, 3.9762470624694347`*^9}, {
  3.976296387755316*^9, 3.976296410449286*^9}, {3.9762967363562517`*^9, 
  3.976296736736766*^9}},
 CellLabel->"In[26]:=",ExpressionUUID->"f100b477-6109-4002-8014-50ed825e8e06"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"dist", "[", "mat_", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"A", ",", "Z", ",", "y"}], "}"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"A", "[", "1", "]"}], "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"ListCorrelate", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"W", "[", "1", "]"}], "[", 
           RowBox[{"[", "j", "]"}], "]"}], ",", "mat"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "32"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Z", "[", "1", "]"}], "=", 
      RowBox[{"Ramp", "[", 
       RowBox[{"A", "[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "[", "2", "]"}], "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"Total", "[", 
         RowBox[{"MapThread", "[", 
          RowBox[{"ListCorrelate", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"W", "[", "2", "]"}], "[", 
              RowBox[{"[", "j", "]"}], "]"}], ",", 
             RowBox[{"Z", "[", "1", "]"}]}], "}"}]}], "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "64"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Z", "[", "2", "]"}], "=", 
      RowBox[{"Ramp", "[", 
       RowBox[{"A", "[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "[", "3", "]"}], "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"Total", "[", 
         RowBox[{"MapThread", "[", 
          RowBox[{"ListCorrelate", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"W", "[", "3", "]"}], "[", 
              RowBox[{"[", "j", "]"}], "]"}], ",", 
             RowBox[{"Z", "[", "2", "]"}]}], "}"}]}], "]"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "64"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Z", "[", "3", "]"}], "=", 
      RowBox[{"Ramp", "[", 
       RowBox[{"A", "[", "3", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "[", "4", "]"}], "=", 
      RowBox[{
       RowBox[{
        RowBox[{"maxpool", "[", 
         RowBox[{"#", ",", 
          RowBox[{"{", 
           RowBox[{"2", ",", "2"}], "}"}]}], "]"}], "&"}], "/@", 
       RowBox[{"Z", "[", "3", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Z", "[", "4", "]"}], "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{"A", "[", "4", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "[", "5", "]"}], "=", 
      RowBox[{
       RowBox[{
        RowBox[{"W", "[", "5", "]"}], ".", 
        RowBox[{"Z", "[", "4", "]"}]}], "+", 
       RowBox[{"b", "[", "5", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Z", "[", "5", "]"}], "=", 
      RowBox[{"Ramp", "[", 
       RowBox[{"A", "[", "5", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "[", "6", "]"}], "=", 
      RowBox[{
       RowBox[{
        RowBox[{"W", "[", "6", "]"}], ".", 
        RowBox[{"Z", "[", "5", "]"}]}], "+", 
       RowBox[{"b", "[", "6", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Z", "[", "6", "]"}], "=", 
      RowBox[{"Ramp", "[", 
       RowBox[{"A", "[", "6", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "[", "7", "]"}], "=", 
      RowBox[{
       RowBox[{
        RowBox[{"W", "[", "7", "]"}], ".", 
        RowBox[{"Z", "[", "6", "]"}]}], "+", 
       RowBox[{"b", "[", "7", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"y", "=", 
      RowBox[{"Exp", "[", 
       RowBox[{"A", "[", "7", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"y", "=", 
      RowBox[{"y", "/", 
       RowBox[{"Total", "[", "y", "]"}]}]}]}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pred", "[", "mat_", "]"}], ":=", 
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"y", "=", 
      RowBox[{"dist", "[", "mat", "]"}]}], "}"}], ",", 
    RowBox[{"classes", "[", 
     RowBox[{"[", 
      RowBox[{
       RowBox[{"FirstPosition", "[", 
        RowBox[{"y", ",", 
         RowBox[{"Max", "[", "y", "]"}]}], "]"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}], "]"}], "]"}]}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.976296984690419*^9, 3.976297015081997*^9}, {
  3.9763012115254717`*^9, 3.976301232442272*^9}},
 CellLabel->"In[37]:=",ExpressionUUID->"1c785ead-9043-4112-bd3b-1070b8d6ecc3"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"start", "=", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"i", "=", "1"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "0", "]"}], "=", 
   RowBox[{"data", "[", 
    RowBox[{"[", "i", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"label", "=", 
   RowBox[{"pos", "[", 
    RowBox[{"labels", "[", 
     RowBox[{"[", "i", "]"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<setup \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "1", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"ListCorrelate", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"W", "[", "1", "]"}], "[", 
        RowBox[{"[", "j", "]"}], "]"}], ",", 
       RowBox[{"Z", "[", "0", "]"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "32"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "1", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "1", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<1 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "2", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Total", "[", 
      RowBox[{"MapThread", "[", 
       RowBox[{"ListCorrelate", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{"W", "[", "2", "]"}], "[", 
           RowBox[{"[", "j", "]"}], "]"}], ",", 
          RowBox[{"Z", "[", "1", "]"}]}], "}"}]}], "]"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "64"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "2", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "2", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<2 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "3", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Total", "[", 
      RowBox[{"MapThread", "[", 
       RowBox[{"ListCorrelate", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{"W", "[", "3", "]"}], "[", 
           RowBox[{"[", "j", "]"}], "]"}], ",", 
          RowBox[{"Z", "[", "2", "]"}]}], "}"}]}], "]"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "64"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "3", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "3", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<3 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "4", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"maxpool", "[", 
      RowBox[{"#", ",", 
       RowBox[{"{", 
        RowBox[{"2", ",", "2"}], "}"}]}], "]"}], "&"}], "/@", 
    RowBox[{"Z", "[", "3", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "4", "]"}], "=", 
   RowBox[{"Flatten", "[", 
    RowBox[{"A", "[", "4", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<4 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "5", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"W", "[", "5", "]"}], ".", 
     RowBox[{"Z", "[", "4", "]"}]}], "+", 
    RowBox[{"b", "[", "5", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "5", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "5", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<5 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "6", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"W", "[", "6", "]"}], ".", 
     RowBox[{"Z", "[", "5", "]"}]}], "+", 
    RowBox[{"b", "[", "6", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "6", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "6", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<6 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "7", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{"W", "[", "7", "]"}], ".", 
     RowBox[{"Z", "[", "6", "]"}]}], "+", 
    RowBox[{"b", "[", "7", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"y", "=", 
   RowBox[{"Exp", "[", 
    RowBox[{"A", "[", "7", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"y", "=", 
   RowBox[{"y", "/", 
    RowBox[{"Total", "[", "y", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<pred \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"labelVec", "=", 
   RowBox[{"UnitVector", "[", 
    RowBox[{"nClasses", ",", "label"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"e", "[", "7", "]"}], "=", 
   RowBox[{"y", "-", "labelVec"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b7 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"e", "[", "j", "]"}], "=", 
     RowBox[{
      RowBox[{
       RowBox[{"e", "[", 
        RowBox[{"j", "+", "1"}], "]"}], ".", 
       RowBox[{"W", "[", 
        RowBox[{"j", "+", "1"}], "]"}]}], 
      RowBox[{"Transpose", "[", 
       RowBox[{"Unitize", "[", 
        RowBox[{"Z", "[", "j", "]"}], "]"}], "]"}]}]}], ",", 
    RowBox[{"{", 
     RowBox[{"j", ",", "6", ",", "4", ",", 
      RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b654 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"e", "[", "3", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"ArrayFlatten", "[", 
      RowBox[{
       RowBox[{"Partition", "[", 
        RowBox[{
         RowBox[{"maxpoolD", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Z", "[", "3", "]"}], "[", 
            RowBox[{"[", "j", "]"}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "2"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"2", ",", "2"}], "}"}]}], "]"}], 
       RowBox[{
        RowBox[{"Partition", "[", 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{
            RowBox[{"e", "[", "4", "]"}], ",", "11"}], "]"}], ",", "11"}], 
         "]"}], "[", 
        RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "64"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b3 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"e", "[", "2", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Sum", "[", 
      RowBox[{
       RowBox[{"ListConvolve", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"W", "[", "3", "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"j", ",", "i"}], "]"}], "]"}], ",", 
         RowBox[{"ArrayPad", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"e", "[", "3", "]"}], "[", 
            RowBox[{"[", "j", "]"}], "]"}], ",", "2"}], "]"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "64"}], "}"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "64"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b2 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"e", "[", "1", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Sum", "[", 
      RowBox[{
       RowBox[{"ListConvolve", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"W", "[", "2", "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"j", ",", "i"}], "]"}], "]"}], ",", 
         RowBox[{"ArrayPad", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"e", "[", "2", "]"}], "[", 
            RowBox[{"[", "j", "]"}], "]"}], ",", "2"}], "]"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "64"}], "}"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "32"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b1 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Do", "[", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"gradQW", "[", "j", "]"}], "=", 
     RowBox[{"KroneckerProduct", "[", 
      RowBox[{
       RowBox[{"e", "[", "j", "]"}], ",", 
       RowBox[{"Z", "[", 
        RowBox[{"j", "-", "1"}], "]"}]}], "]"}]}], ";", 
    RowBox[{
     RowBox[{"gradQb", "[", "j", "]"}], "=", 
     RowBox[{"e", "[", "j", "]"}]}]}], ",", 
   RowBox[{"{", 
    RowBox[{"j", ",", "5", ",", "7"}], "}"}]}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<w567 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"gradQW", "[", "3", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"ListCorrelate", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"e", "[", "3", "]"}], "[", 
        RowBox[{"[", "j", "]"}], "]"}], ",", 
       RowBox[{
        RowBox[{"Z", "[", "2", "]"}], "[", 
        RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "64"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "64"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<w3 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"gradQW", "[", "2", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"ListCorrelate", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"e", "[", "2", "]"}], "[", 
        RowBox[{"[", "j", "]"}], "]"}], ",", 
       RowBox[{
        RowBox[{"Z", "[", "1", "]"}], "[", 
        RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "64"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "32"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<w2 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"gradQW", "[", "1", "]"}], "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"ListCorrelate", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"e", "[", "1", "]"}], "[", 
        RowBox[{"[", "j", "]"}], "]"}], ",", 
       RowBox[{"Z", "[", "0", "]"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "32"}], "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<w1 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<end \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<total \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "start"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.976231061055578*^9, 3.97623108285287*^9}, {
   3.97623220302883*^9, 3.976232209464281*^9}, {3.976237320041429*^9, 
   3.976237349017597*^9}, {3.9762395995500107`*^9, 3.976239623594549*^9}, {
   3.9762396653753757`*^9, 3.976239862842849*^9}, {3.976241401200964*^9, 
   3.9762414328846684`*^9}, {3.976241494639925*^9, 3.97624149599325*^9}, {
   3.976241616063921*^9, 3.9762416281120987`*^9}, {3.976241728387857*^9, 
   3.976241728526182*^9}, {3.976241760595976*^9, 3.97624176597969*^9}, {
   3.97624191199116*^9, 3.9762420016571198`*^9}, {3.976242380846653*^9, 
   3.976242396501152*^9}, {3.976243090097048*^9, 3.976243094674457*^9}, {
   3.976245373873269*^9, 3.976245390938095*^9}, {3.976245464027341*^9, 
   3.9762454665298243`*^9}, {3.976245521932541*^9, 3.976245523581923*^9}, {
   3.976246708087772*^9, 3.976246714123077*^9}, {3.976247608730494*^9, 
   3.976247609040072*^9}, {3.9762477198395576`*^9, 3.9762477405994577`*^9}, {
   3.976247911319607*^9, 3.97624792402452*^9}, {3.976248038612817*^9, 
   3.976248083276375*^9}, {3.9762481466019773`*^9, 3.976248183608138*^9}, 
   3.976282055449154*^9},
 CellLabel->"In[42]:=",ExpressionUUID->"92e9fd24-d83c-4c6c-a97e-0a9464d37b30"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"shuffle", "=", 
   RowBox[{"Partition", "[", 
    RowBox[{
     RowBox[{"RandomSample", "[", 
      RowBox[{"Range", "[", "nTrain", "]"}], "]"}], ",", 
     RowBox[{"UpTo", "[", "batchSize", "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nBatches", "=", 
   RowBox[{"Length", "[", "shuffle", "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.976282010387782*^9, 3.976282045867313*^9}, {
  3.9762821725498323`*^9, 3.976282173130726*^9}, {3.976282207427511*^9, 
  3.976282211966185*^9}, {3.9762976885370483`*^9, 3.976297689093498*^9}, {
  3.976297835975016*^9, 3.9762978412962914`*^9}},
 CellLabel->"In[39]:=",ExpressionUUID->"fc6c9a35-c9f1-4bdb-86a8-2c6d470e1cfb"],

Cell[BoxData[
 RowBox[{"Monitor", "[", 
  RowBox[{
   RowBox[{"Do", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"now", "=", 
       RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"batch", "=", 
       RowBox[{"shuffle", "[", 
        RowBox[{"[", "p", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"nBatch", "=", 
       RowBox[{"Length", "[", "batch", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"dataBatch", "=", 
       RowBox[{"data", "[", 
        RowBox[{"[", "batch", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rVec", "=", 
       RowBox[{"pos", "/@", 
        RowBox[{"labels", "[", 
         RowBox[{"[", "batch", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"ParallelDo", "[", 
       RowBox[{
        RowBox[{"Block", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
           "Z", ",", "A", ",", "y", ",", "label", ",", "labelVec", ",", "e"}],
            "}"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"ClearAll", "[", 
            RowBox[{"gradQW", ",", "gradQb"}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"Do", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"gradQW", "[", 
               RowBox[{"$KernelID", ",", "index"}], "]"}], "=", 
              RowBox[{"ConstantArray", "[", 
               RowBox[{"0.", ",", 
                RowBox[{"Dimensions", "[", 
                 RowBox[{"W", "[", "index", "]"}], "]"}]}], "]"}]}], ",", 
             RowBox[{"{", 
              RowBox[{"index", ",", "Windices"}], "}"}]}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"Do", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"gradQb", "[", 
               RowBox[{"$KernelID", ",", "index"}], "]"}], "=", 
              RowBox[{"ConstantArray", "[", 
               RowBox[{"0.", ",", 
                RowBox[{"Dimensions", "[", 
                 RowBox[{"b", "[", "index", "]"}], "]"}]}], "]"}]}], ",", 
             RowBox[{"{", 
              RowBox[{"index", ",", "bindices"}], "}"}]}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Z", "[", "0", "]"}], "=", 
            RowBox[{"dataBatch", "[", 
             RowBox[{"[", "k", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"label", "=", 
            RowBox[{"rVec", "[", 
             RowBox[{"[", "k", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"A", "[", "1", "]"}], "=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"ListCorrelate", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"W", "[", "1", "]"}], "[", 
                 RowBox[{"[", "j", "]"}], "]"}], ",", 
                RowBox[{"Z", "[", "0", "]"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "32"}], "}"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Z", "[", "1", "]"}], "=", 
            RowBox[{"Ramp", "[", 
             RowBox[{"A", "[", "1", "]"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"A", "[", "2", "]"}], "=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"Total", "[", 
               RowBox[{"MapThread", "[", 
                RowBox[{"ListCorrelate", ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"W", "[", "2", "]"}], "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", 
                   RowBox[{"Z", "[", "1", "]"}]}], "}"}]}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "64"}], "}"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Z", "[", "2", "]"}], "=", 
            RowBox[{"Ramp", "[", 
             RowBox[{"A", "[", "2", "]"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"A", "[", "3", "]"}], "=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"Total", "[", 
               RowBox[{"MapThread", "[", 
                RowBox[{"ListCorrelate", ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"W", "[", "3", "]"}], "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", 
                   RowBox[{"Z", "[", "2", "]"}]}], "}"}]}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "64"}], "}"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Z", "[", "3", "]"}], "=", 
            RowBox[{"Ramp", "[", 
             RowBox[{"A", "[", "3", "]"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"A", "[", "4", "]"}], "=", 
            RowBox[{
             RowBox[{
              RowBox[{"maxpool", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", 
                 RowBox[{"2", ",", "2"}], "}"}]}], "]"}], "&"}], "/@", 
             RowBox[{"Z", "[", "3", "]"}]}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Z", "[", "4", "]"}], "=", 
            RowBox[{"Flatten", "[", 
             RowBox[{"A", "[", "4", "]"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"A", "[", "5", "]"}], "=", 
            RowBox[{
             RowBox[{
              RowBox[{"W", "[", "5", "]"}], ".", 
              RowBox[{"Z", "[", "4", "]"}]}], "+", 
             RowBox[{"b", "[", "5", "]"}]}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Z", "[", "5", "]"}], "=", 
            RowBox[{"Ramp", "[", 
             RowBox[{"A", "[", "5", "]"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"A", "[", "6", "]"}], "=", 
            RowBox[{
             RowBox[{
              RowBox[{"W", "[", "6", "]"}], ".", 
              RowBox[{"Z", "[", "5", "]"}]}], "+", 
             RowBox[{"b", "[", "6", "]"}]}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Z", "[", "6", "]"}], "=", 
            RowBox[{"Ramp", "[", 
             RowBox[{"A", "[", "6", "]"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"A", "[", "7", "]"}], "=", 
            RowBox[{
             RowBox[{
              RowBox[{"W", "[", "7", "]"}], ".", 
              RowBox[{"Z", "[", "6", "]"}]}], "+", 
             RowBox[{"b", "[", "7", "]"}]}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"y", "=", 
            RowBox[{"Exp", "[", 
             RowBox[{"A", "[", "7", "]"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"y", "=", 
            RowBox[{"y", "/", 
             RowBox[{"Total", "[", "y", "]"}]}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"labelVec", "=", 
            RowBox[{"UnitVector", "[", 
             RowBox[{"nClasses", ",", "label"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"e", "[", "7", "]"}], "=", 
            RowBox[{"y", "-", "labelVec"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"Do", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"e", "[", "j", "]"}], "=", 
              RowBox[{
               RowBox[{
                RowBox[{"e", "[", 
                 RowBox[{"j", "+", "1"}], "]"}], ".", 
                RowBox[{"W", "[", 
                 RowBox[{"j", "+", "1"}], "]"}]}], 
               RowBox[{"Transpose", "[", 
                RowBox[{"Unitize", "[", 
                 RowBox[{"Z", "[", "j", "]"}], "]"}], "]"}]}]}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "6", ",", "4", ",", 
               RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"e", "[", "3", "]"}], "=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"ArrayFlatten", "[", 
               RowBox[{
                RowBox[{"Partition", "[", 
                 RowBox[{
                  RowBox[{"maxpoolD", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Z", "[", "3", "]"}], "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"2", ",", "2"}], "}"}]}], "]"}], ",", 
                  RowBox[{"{", 
                   RowBox[{"2", ",", "2"}], "}"}]}], "]"}], 
                RowBox[{
                 RowBox[{"Partition", "[", 
                  RowBox[{
                   RowBox[{"Partition", "[", 
                    RowBox[{
                    RowBox[{"e", "[", "4", "]"}], ",", "11"}], "]"}], ",", 
                   "11"}], "]"}], "[", 
                 RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "64"}], "}"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"e", "[", "2", "]"}], "=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"Sum", "[", 
               RowBox[{
                RowBox[{"ListConvolve", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"W", "[", "3", "]"}], "[", 
                   RowBox[{"[", 
                    RowBox[{"j", ",", "i"}], "]"}], "]"}], ",", 
                  RowBox[{"ArrayPad", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"e", "[", "3", "]"}], "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "2"}], "]"}]}], 
                 "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"j", ",", "64"}], "}"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"i", ",", "64"}], "}"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"e", "[", "1", "]"}], "=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"Sum", "[", 
               RowBox[{
                RowBox[{"ListConvolve", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"W", "[", "2", "]"}], "[", 
                   RowBox[{"[", 
                    RowBox[{"j", ",", "i"}], "]"}], "]"}], ",", 
                  RowBox[{"ArrayPad", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"e", "[", "2", "]"}], "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "2"}], "]"}]}], 
                 "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"j", ",", "64"}], "}"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"i", ",", "32"}], "}"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"Do", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"gradQW", "[", 
                RowBox[{"$KernelID", ",", "j"}], "]"}], "+=", 
               RowBox[{"KroneckerProduct", "[", 
                RowBox[{
                 RowBox[{"e", "[", "j", "]"}], ",", 
                 RowBox[{"Z", "[", 
                  RowBox[{"j", "-", "1"}], "]"}]}], "]"}]}], ";", 
              RowBox[{
               RowBox[{"gradQb", "[", 
                RowBox[{"$KernelID", ",", "j"}], "]"}], "+=", 
               RowBox[{"e", "[", "j", "]"}]}]}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "5", ",", "7"}], "}"}]}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"gradQW", "[", 
             RowBox[{"$KernelID", ",", "3"}], "]"}], "+=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"ListCorrelate", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"e", "[", "3", "]"}], "[", 
                 RowBox[{"[", "j", "]"}], "]"}], ",", 
                RowBox[{
                 RowBox[{"Z", "[", "2", "]"}], "[", 
                 RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "64"}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"i", ",", "64"}], "}"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"gradQW", "[", 
             RowBox[{"$KernelID", ",", "2"}], "]"}], "+=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"ListCorrelate", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"e", "[", "2", "]"}], "[", 
                 RowBox[{"[", "j", "]"}], "]"}], ",", 
                RowBox[{
                 RowBox[{"Z", "[", "1", "]"}], "[", 
                 RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "64"}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"i", ",", "32"}], "}"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"gradQW", "[", 
             RowBox[{"$KernelID", ",", "1"}], "]"}], "+=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"ListCorrelate", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"e", "[", "1", "]"}], "[", 
                 RowBox[{"[", "j", "]"}], "]"}], ",", 
                RowBox[{"Z", "[", "0", "]"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "32"}], "}"}]}], "]"}]}]}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"k", ",", "nBatch"}], "}"}], ",", 
        RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"ClearAll", "[", 
       RowBox[{"Wresults", ",", "bresults"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Wresults", "[", "#", "]"}], "=", 
          RowBox[{"Total", "[", 
           RowBox[{"ParallelEvaluate", "[", 
            RowBox[{"gradQW", "[", 
             RowBox[{"$KernelID", ",", "#"}], "]"}], "]"}], "]"}]}], ")"}], 
        "&"}], "/@", "Windices"}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"bresults", "[", "#", "]"}], "=", 
          RowBox[{"Total", "[", 
           RowBox[{"ParallelEvaluate", "[", 
            RowBox[{"gradQb", "[", 
             RowBox[{"$KernelID", ",", "#"}], "]"}], "]"}], "]"}]}], ")"}], 
        "&"}], "/@", "Windices"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"W", "[", "index", "]"}], "-=", 
         RowBox[{"lr", " ", 
          RowBox[{
           RowBox[{"Wresults", "[", "index", "]"}], "/", "nBatch"}]}]}], ",", 
        
        RowBox[{"{", 
         RowBox[{"index", ",", "Windices"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"b", "[", "index", "]"}], "-=", 
         RowBox[{"lr", " ", 
          RowBox[{
           RowBox[{"bresults", "[", "index", "]"}], "/", "nBatch"}]}]}], ",", 
        
        RowBox[{"{", 
         RowBox[{"index", ",", "bindices"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Print", "[", 
       RowBox[{
        RowBox[{"SessionTime", "[", "]"}], "-", "now"}], "]"}]}], ",", 
     RowBox[{"{", 
      RowBox[{"p", ",", "nBatches"}], "}"}]}], "]"}], ",", 
   RowBox[{"{", 
    RowBox[{"p", ",", "nBatches"}], "}"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.976282081743705*^9, 3.976282113739649*^9}, {
   3.976282145507696*^9, 3.976282322970564*^9}, {3.9762823824491873`*^9, 
   3.976282388581058*^9}, {3.9762824193070993`*^9, 3.9762824523252487`*^9}, 
   3.976282487736343*^9, {3.976282562672517*^9, 3.976282627125929*^9}, {
   3.97628330785119*^9, 3.976283309996447*^9}, {3.976295764718308*^9, 
   3.976295948176709*^9}, {3.9762964983559723`*^9, 3.97629657278363*^9}, {
   3.9762966128786*^9, 3.97629664410893*^9}, 3.976296945719309*^9, {
   3.9762972519163733`*^9, 3.976297262613738*^9}, {3.976297294196178*^9, 
   3.976297409577026*^9}, {3.976297442570848*^9, 3.976297483057811*^9}, {
   3.9762975411291656`*^9, 3.976297568612174*^9}, {3.976297797208794*^9, 
   3.976297812748835*^9}, {3.976297849209238*^9, 3.9762978615127583`*^9}, {
   3.976297909345989*^9, 3.9762979158190947`*^9}, 3.976298040363579*^9, {
   3.976324484371892*^9, 3.97632448995433*^9}, {3.976331210358782*^9, 
   3.976331211349771*^9}, {3.976332396863339*^9, 3.9763324169324493`*^9}},
 CellLabel->"In[41]:=",ExpressionUUID->"bea84773-e3d1-4f98-91bf-65932e4a0942"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"shuffle", "=", 
   RowBox[{"Partition", "[", 
    RowBox[{
     RowBox[{"RandomSample", "[", 
      RowBox[{"Range", "[", "nTrain", "]"}], "]"}], ",", 
     RowBox[{"UpTo", "[", "batchSize", "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nBatches", "=", 
   RowBox[{"Length", "[", "shuffle", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Monitor", "[", 
  RowBox[{
   RowBox[{"Do", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"now", "=", 
       RowBox[{"SessionTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"batch", "=", 
       RowBox[{"shuffle", "[", 
        RowBox[{"[", "p", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"nBatch", "=", 
       RowBox[{"Length", "[", "batch", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"dataBatch", "=", 
       RowBox[{"data", "[", 
        RowBox[{"[", "batch", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"rVec", "=", 
       RowBox[{"pos", "/@", 
        RowBox[{"labels", "[", 
         RowBox[{"[", "batch", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Z", "[", "0", "]"}], "=", "dataBatch"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"A", "[", "1", "]"}], "=", 
       RowBox[{"Parallelize", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"ListCorrelate", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"W", "[", "1", "]"}], "[", 
                RowBox[{"[", "j", "]"}], "]"}], ",", "#"}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "32"}], "}"}]}], "]"}], "&"}], "/@", 
          RowBox[{"Z", "[", "0", "]"}]}], ",", 
         RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Z", "[", "1", "]"}], "=", 
       RowBox[{"Ramp", "[", 
        RowBox[{"A", "[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"A", "[", "2", "]"}], "=", 
       RowBox[{"Parallelize", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"Total", "[", 
              RowBox[{"MapThread", "[", 
               RowBox[{"ListCorrelate", ",", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"W", "[", "2", "]"}], "[", 
                   RowBox[{"[", "j", "]"}], "]"}], ",", "#"}], "}"}]}], "]"}],
               "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "64"}], "}"}]}], "]"}], "&"}], "/@", 
          RowBox[{"Z", "[", "1", "]"}]}], ",", 
         RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Z", "[", "2", "]"}], "=", 
       RowBox[{"Ramp", "[", 
        RowBox[{"A", "[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"A", "[", "3", "]"}], "=", 
       RowBox[{"Parallelize", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"Total", "[", 
              RowBox[{"MapThread", "[", 
               RowBox[{"ListCorrelate", ",", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"W", "[", "3", "]"}], "[", 
                   RowBox[{"[", "j", "]"}], "]"}], ",", "#"}], "}"}]}], "]"}],
               "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "64"}], "}"}]}], "]"}], "&"}], "/@", 
          RowBox[{"Z", "[", "2", "]"}]}], ",", 
         RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Z", "[", "3", "]"}], "=", 
       RowBox[{"Ramp", "[", 
        RowBox[{"A", "[", "3", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"A", "[", "4", "]"}], "=", 
       RowBox[{"Parallelize", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{
              RowBox[{"maxpool", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", 
                 RowBox[{"2", ",", "2"}], "}"}]}], "]"}], "&"}], "/@", "#"}], 
            ")"}], "&"}], "/@", 
          RowBox[{"Z", "[", "3", "]"}]}], ",", 
         RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Z", "[", "4", "]"}], "=", 
       RowBox[{"Flatten", "/@", 
        RowBox[{"A", "[", "4", "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"A", "[", "5", "]"}], "=", 
       RowBox[{"Parallelize", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"W", "[", "5", "]"}], ".", "#"}], "+", 
            RowBox[{"b", "[", "5", "]"}]}], "&"}], "/@", 
          RowBox[{"Z", "[", "4", "]"}]}], ",", 
         RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Z", "[", "5", "]"}], "=", 
       RowBox[{"Ramp", "[", 
        RowBox[{"A", "[", "5", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"A", "[", "6", "]"}], "=", 
       RowBox[{"Parallelize", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"W", "[", "6", "]"}], ".", "#"}], "+", 
            RowBox[{"b", "[", "6", "]"}]}], "&"}], "/@", 
          RowBox[{"Z", "[", "5", "]"}]}], ",", 
         RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Z", "[", "6", "]"}], "=", 
       RowBox[{"Ramp", "[", 
        RowBox[{"A", "[", "6", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"A", "[", "7", "]"}], "=", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"W", "[", "7", "]"}], ".", "#"}], "+", 
          RowBox[{"b", "[", "7", "]"}]}], "&"}], "/@", 
        RowBox[{"Z", "[", "6", "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"y", "=", 
       RowBox[{"Exp", "[", 
        RowBox[{"A", "[", "7", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"y", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"#", "/", 
          RowBox[{"Total", "[", "#", "]"}]}], "&"}], "/@", "y"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"labelMat", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"UnitVector", "[", 
          RowBox[{"nClasses", ",", "#"}], "]"}], "&"}], "/@", "rVec"}]}], ";",
       "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"e", "[", "7", "]"}], "=", 
       RowBox[{"y", "-", "labelMat"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"e", "[", "j", "]"}], "=", 
         RowBox[{
          RowBox[{
           RowBox[{"e", "[", 
            RowBox[{"j", "+", "1"}], "]"}], ".", 
           RowBox[{"W", "[", 
            RowBox[{"j", "+", "1"}], "]"}]}], 
          RowBox[{"Unitize", "[", 
           RowBox[{"Z", "[", "j", "]"}], "]"}]}]}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "6", ",", "4", ",", 
          RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"e", "[", "3", "]"}], "=", 
       RowBox[{"ParallelTable", "[", 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"ArrayFlatten", "[", 
            RowBox[{
             RowBox[{"Partition", "[", 
              RowBox[{
               RowBox[{"maxpoolD", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"Z", "[", "3", "]"}], "[", 
                   RowBox[{"[", "i", "]"}], "]"}], "[", 
                  RowBox[{"[", "j", "]"}], "]"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"2", ",", "2"}], "}"}]}], "]"}], ",", 
               RowBox[{"{", 
                RowBox[{"2", ",", "2"}], "}"}]}], "]"}], 
             RowBox[{
              RowBox[{"Partition", "[", 
               RowBox[{
                RowBox[{"Partition", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"e", "[", "4", "]"}], "[", 
                   RowBox[{"[", "i", "]"}], "]"}], ",", "11"}], "]"}], ",", 
                "11"}], "]"}], "[", 
              RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"j", ",", "64"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "nBatch"}], "}"}], ",", 
         RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"e", "[", "2", "]"}], "=", 
       RowBox[{"Parallelize", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"Sum", "[", 
              RowBox[{
               RowBox[{"ListConvolve", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"W", "[", "3", "]"}], "[", 
                  RowBox[{"[", 
                   RowBox[{"j", ",", "i"}], "]"}], "]"}], ",", 
                 RowBox[{"ArrayPad", "[", 
                  RowBox[{
                   RowBox[{"#", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "2"}], "]"}]}], 
                "]"}], ",", 
               RowBox[{"{", 
                RowBox[{"j", ",", "64"}], "}"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "64"}], "}"}]}], "]"}], "&"}], "/@", 
          RowBox[{"e", "[", "3", "]"}]}], ",", 
         RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"e", "[", "1", "]"}], "=", 
       RowBox[{"Parallelize", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"Sum", "[", 
              RowBox[{
               RowBox[{"ListConvolve", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"W", "[", "2", "]"}], "[", 
                  RowBox[{"[", 
                   RowBox[{"j", ",", "i"}], "]"}], "]"}], ",", 
                 RowBox[{"ArrayPad", "[", 
                  RowBox[{
                   RowBox[{"#", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "2"}], "]"}]}], 
                "]"}], ",", 
               RowBox[{"{", 
                RowBox[{"j", ",", "64"}], "}"}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "32"}], "}"}]}], "]"}], "&"}], "/@", 
          RowBox[{"e", "[", "2", "]"}]}], ",", 
         RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"gradQW", "[", "j", "]"}], "=", 
          RowBox[{
           RowBox[{"Transpose", "[", 
            RowBox[{"e", "[", "j", "]"}], "]"}], ".", 
           RowBox[{"Z", "[", 
            RowBox[{"j", "-", "1"}], "]"}]}]}], ";", 
         RowBox[{
          RowBox[{"gradQb", "[", "j", "]"}], "=", 
          RowBox[{"Total", "[", 
           RowBox[{"e", "[", "j", "]"}], "]"}]}]}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "5", ",", "7"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"gradQW", "[", "3", "]"}], "=", 
       RowBox[{"ParallelSum", "[", 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"ListCorrelate", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"e", "[", "3", "]"}], "[", 
               RowBox[{"[", "l", "]"}], "]"}], "[", 
              RowBox[{"[", "j", "]"}], "]"}], ",", 
             RowBox[{
              RowBox[{
               RowBox[{"Z", "[", "2", "]"}], "[", 
               RowBox[{"[", "l", "]"}], "]"}], "[", 
              RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"j", ",", "64"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", "64"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"l", ",", "nBatch"}], "}"}], ",", 
         RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"gradQW", "[", "2", "]"}], "=", 
       RowBox[{"ParallelSum", "[", 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"ListCorrelate", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"e", "[", "2", "]"}], "[", 
               RowBox[{"[", "l", "]"}], "]"}], "[", 
              RowBox[{"[", "j", "]"}], "]"}], ",", 
             RowBox[{
              RowBox[{
               RowBox[{"Z", "[", "1", "]"}], "[", 
               RowBox[{"[", "l", "]"}], "]"}], "[", 
              RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"j", ",", "64"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", "32"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"l", ",", "nBatch"}], "}"}], ",", 
         RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"gradQW", "[", "1", "]"}], "=", 
       RowBox[{"ParallelSum", "[", 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"ListCorrelate", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"e", "[", "1", "]"}], "[", 
               RowBox[{"[", "i", "]"}], "]"}], "[", 
              RowBox[{"[", "j", "]"}], "]"}], ",", 
             RowBox[{
              RowBox[{"Z", "[", "0", "]"}], "[", 
              RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"j", ",", "32"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "nBatch"}], "}"}], ",", 
         RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"W", "[", "index", "]"}], "-=", 
         RowBox[{"lr", " ", 
          RowBox[{
           RowBox[{"gradQW", "[", "index", "]"}], "/", "nBatch"}]}]}], ",", 
        RowBox[{"{", 
         RowBox[{"index", ",", "Windices"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"b", "[", "index", "]"}], "-=", 
         RowBox[{"lr", " ", 
          RowBox[{
           RowBox[{"gradQb", "[", "index", "]"}], "/", "nBatch"}]}]}], ",", 
        RowBox[{"{", 
         RowBox[{"index", ",", "bindices"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Print", "[", 
       RowBox[{
        RowBox[{"SessionTime", "[", "]"}], "-", "now"}], "]"}]}], ",", 
     RowBox[{"{", 
      RowBox[{"p", ",", "nBatches"}], "}"}]}], "]"}], ",", 
   RowBox[{"{", 
    RowBox[{"p", ",", "nBatches"}], "}"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.976298313915066*^9, 3.9762983191644506`*^9}, {
  3.9762983589946413`*^9, 3.976298405990985*^9}, {3.9763217418068247`*^9, 
  3.9763218228238077`*^9}, {3.976324468840603*^9, 3.9763244740749598`*^9}, {
  3.9763314282064953`*^9, 3.9763316925270443`*^9}, {3.9763317564429197`*^9, 
  3.9763317692506647`*^9}},
 CellLabel->"In[59]:=",ExpressionUUID->"4093261b-bb3d-4694-9685-fbed0406f62c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"batch", "=", 
   RowBox[{"shuffle", "[", 
    RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nBatch", "=", 
   RowBox[{"Length", "[", "batch", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"dataBatch", "=", 
   RowBox[{"data", "[", 
    RowBox[{"[", "batch", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"rVec", "=", 
   RowBox[{"pos", "/@", 
    RowBox[{"labels", "[", 
     RowBox[{"[", "batch", "]"}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"start", "=", 
   RowBox[{"now", "=", 
    RowBox[{"SessionTime", "[", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "0", "]"}], "=", "dataBatch"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"rVec", ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<setup \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "1", "]"}], "=", 
   RowBox[{"Parallelize", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"ListCorrelate", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"W", "[", "1", "]"}], "[", 
            RowBox[{"[", "j", "]"}], "]"}], ",", "#"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "32"}], "}"}]}], "]"}], "&"}], "/@", 
      RowBox[{"Z", "[", "0", "]"}]}], ",", 
     RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "1", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "1", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<1 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "2", "]"}], "=", 
   RowBox[{"Parallelize", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Total", "[", 
          RowBox[{"MapThread", "[", 
           RowBox[{"ListCorrelate", ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"W", "[", "2", "]"}], "[", 
               RowBox[{"[", "j", "]"}], "]"}], ",", "#"}], "}"}]}], "]"}], 
          "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "64"}], "}"}]}], "]"}], "&"}], "/@", 
      RowBox[{"Z", "[", "1", "]"}]}], ",", 
     RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "2", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "2", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<2 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "3", "]"}], "=", 
   RowBox[{"Parallelize", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Total", "[", 
          RowBox[{"MapThread", "[", 
           RowBox[{"ListCorrelate", ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"W", "[", "3", "]"}], "[", 
               RowBox[{"[", "j", "]"}], "]"}], ",", "#"}], "}"}]}], "]"}], 
          "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"j", ",", "64"}], "}"}]}], "]"}], "&"}], "/@", 
      RowBox[{"Z", "[", "2", "]"}]}], ",", 
     RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";"}], 
"\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "3", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "3", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<3 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "4", "]"}], "=", 
   RowBox[{"Parallelize", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"maxpool", "[", 
           RowBox[{"#", ",", 
            RowBox[{"{", 
             RowBox[{"2", ",", "2"}], "}"}]}], "]"}], "&"}], "/@", "#"}], 
        ")"}], "&"}], "/@", 
      RowBox[{"Z", "[", "3", "]"}]}], ",", 
     RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "4", "]"}], "=", 
   RowBox[{"Flatten", "/@", 
    RowBox[{"A", "[", "4", "]"}]}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<4 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "5", "]"}], "=", 
   RowBox[{"Parallelize", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"W", "[", "5", "]"}], ".", "#"}], "+", 
        RowBox[{"b", "[", "5", "]"}]}], "&"}], "/@", 
      RowBox[{"Z", "[", "4", "]"}]}], ",", 
     RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "5", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "5", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<5 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "6", "]"}], "=", 
   RowBox[{"Parallelize", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"W", "[", "6", "]"}], ".", "#"}], "+", 
        RowBox[{"b", "[", "6", "]"}]}], "&"}], "/@", 
      RowBox[{"Z", "[", "5", "]"}]}], ",", 
     RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Z", "[", "6", "]"}], "=", 
   RowBox[{"Ramp", "[", 
    RowBox[{"A", "[", "6", "]"}], "]"}]}], ";"}], "\n", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<6 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"A", "[", "7", "]"}], "=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"W", "[", "7", "]"}], ".", "#"}], "+", 
      RowBox[{"b", "[", "7", "]"}]}], "&"}], "/@", 
    RowBox[{"Z", "[", "6", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"y", "=", 
   RowBox[{"Exp", "[", 
    RowBox[{"A", "[", "7", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"y", "=", 
   RowBox[{
    RowBox[{
     RowBox[{"#", "/", 
      RowBox[{"Total", "[", "#", "]"}]}], "&"}], "/@", "y"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<pred \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"labelMat", "=", 
   RowBox[{
    RowBox[{
     RowBox[{"UnitVector", "[", 
      RowBox[{"nClasses", ",", "#"}], "]"}], "&"}], "/@", "rVec"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"e", "[", "7", "]"}], "=", 
   RowBox[{"y", "-", "labelMat"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b7 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Do", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"e", "[", "j", "]"}], "=", 
     RowBox[{
      RowBox[{
       RowBox[{"e", "[", 
        RowBox[{"j", "+", "1"}], "]"}], ".", 
       RowBox[{"W", "[", 
        RowBox[{"j", "+", "1"}], "]"}]}], 
      RowBox[{"Unitize", "[", 
       RowBox[{"Z", "[", "j", "]"}], "]"}]}]}], ",", 
    RowBox[{"{", 
     RowBox[{"j", ",", "6", ",", "4", ",", 
      RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b654 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"e", "[", "3", "]"}], "=", 
   RowBox[{"ParallelTable", "[", 
    RowBox[{
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"ArrayFlatten", "[", 
        RowBox[{
         RowBox[{"Partition", "[", 
          RowBox[{
           RowBox[{"maxpoolD", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"Z", "[", "3", "]"}], "[", 
               RowBox[{"[", "i", "]"}], "]"}], "[", 
              RowBox[{"[", "j", "]"}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "2"}], "}"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "2"}], "}"}]}], "]"}], 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{
            RowBox[{"Partition", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"e", "[", "4", "]"}], "[", 
               RowBox[{"[", "i", "]"}], "]"}], ",", "11"}], "]"}], ",", 
            "11"}], "]"}], "[", 
          RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "64"}], "}"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "nBatch"}], "}"}], ",", 
     RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b3 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"e", "[", "2", "]"}], "=", 
   RowBox[{"Parallelize", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Sum", "[", 
          RowBox[{
           RowBox[{"ListConvolve", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"W", "[", "3", "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"j", ",", "i"}], "]"}], "]"}], ",", 
             RowBox[{"ArrayPad", "[", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "j", "]"}], "]"}], ",", "2"}], "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"j", ",", "64"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "64"}], "}"}]}], "]"}], "&"}], "/@", 
      RowBox[{"e", "[", "3", "]"}]}], ",", 
     RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b2 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"e", "[", "1", "]"}], "=", 
   RowBox[{"Parallelize", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Sum", "[", 
          RowBox[{
           RowBox[{"ListConvolve", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"W", "[", "2", "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"j", ",", "i"}], "]"}], "]"}], ",", 
             RowBox[{"ArrayPad", "[", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", "j", "]"}], "]"}], ",", "2"}], "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"j", ",", "64"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "32"}], "}"}]}], "]"}], "&"}], "/@", 
      RowBox[{"e", "[", "2", "]"}]}], ",", 
     RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<b1 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Do", "[", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"gradQW", "[", "j", "]"}], "=", 
     RowBox[{
      RowBox[{"Transpose", "[", 
       RowBox[{"e", "[", "j", "]"}], "]"}], ".", 
      RowBox[{"Z", "[", 
       RowBox[{"j", "-", "1"}], "]"}]}]}], ";", 
    RowBox[{
     RowBox[{"gradQb", "[", "j", "]"}], "=", 
     RowBox[{"Total", "[", 
      RowBox[{"e", "[", "j", "]"}], "]"}]}]}], ",", 
   RowBox[{"{", 
    RowBox[{"j", ",", "5", ",", "7"}], "}"}]}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<w567 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"gradQW", "[", "3", "]"}], "=", 
   RowBox[{"ParallelSum", "[", 
    RowBox[{
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"ListCorrelate", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"e", "[", "3", "]"}], "[", 
           RowBox[{"[", "l", "]"}], "]"}], "[", 
          RowBox[{"[", "j", "]"}], "]"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"Z", "[", "2", "]"}], "[", 
           RowBox[{"[", "l", "]"}], "]"}], "[", 
          RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "64"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "64"}], "}"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"l", ",", "nBatch"}], "}"}], ",", 
     RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<w3 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"gradQW", "[", "2", "]"}], "=", 
   RowBox[{"ParallelSum", "[", 
    RowBox[{
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"ListCorrelate", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"e", "[", "2", "]"}], "[", 
           RowBox[{"[", "l", "]"}], "]"}], "[", 
          RowBox[{"[", "j", "]"}], "]"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"Z", "[", "1", "]"}], "[", 
           RowBox[{"[", "l", "]"}], "]"}], "[", 
          RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "64"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "32"}], "}"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"l", ",", "nBatch"}], "}"}], ",", 
     RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<w2 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\n", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"gradQW", "[", "1", "]"}], "=", 
   RowBox[{"ParallelSum", "[", 
    RowBox[{
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"ListCorrelate", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"e", "[", "1", "]"}], "[", 
           RowBox[{"[", "i", "]"}], "]"}], "[", 
          RowBox[{"[", "j", "]"}], "]"}], ",", 
         RowBox[{
          RowBox[{"Z", "[", "0", "]"}], "[", 
          RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "32"}], "}"}]}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "nBatch"}], "}"}], ",", 
     RowBox[{"Method", "->", "\"\<CoarsestGrained\>\""}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<w1 \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"now", "=", 
   RowBox[{"SessionTime", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<end \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "now"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", 
  RowBox[{"\"\<total \>\"", ",", 
   RowBox[{
    RowBox[{"SessionTime", "[", "]"}], "-", "start"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.976231061055578*^9, 3.97623108285287*^9}, {
   3.97623220302883*^9, 3.976232209464281*^9}, {3.976237320041429*^9, 
   3.976237349017597*^9}, {3.9762395995500107`*^9, 3.976239623594549*^9}, {
   3.9762396653753757`*^9, 3.976239862842849*^9}, {3.976241401200964*^9, 
   3.9762414328846684`*^9}, {3.976241494639925*^9, 3.97624149599325*^9}, {
   3.976241616063921*^9, 3.9762416281120987`*^9}, {3.976241728387857*^9, 
   3.976241728526182*^9}, {3.976241760595976*^9, 3.97624176597969*^9}, {
   3.97624191199116*^9, 3.9762420016571198`*^9}, {3.976242380846653*^9, 
   3.976242396501152*^9}, {3.976243090097048*^9, 3.976243094674457*^9}, {
   3.976245373873269*^9, 3.976245390938095*^9}, {3.976245464027341*^9, 
   3.9762454665298243`*^9}, {3.976245521932541*^9, 3.976245523581923*^9}, {
   3.976246708087772*^9, 3.976246714123077*^9}, {3.976247608730494*^9, 
   3.976247609040072*^9}, {3.9762477198395576`*^9, 3.9762477405994577`*^9}, {
   3.976247911319607*^9, 3.97624792402452*^9}, {3.976248038612817*^9, 
   3.976248083276375*^9}, {3.9762481466019773`*^9, 3.976248183608138*^9}, 
   3.976282055449154*^9, {3.976292078505702*^9, 3.976292126753358*^9}, {
   3.976292174896186*^9, 3.9762922440017767`*^9}, {3.976292310716098*^9, 
   3.976292322444373*^9}, {3.976298512516231*^9, 3.976298516092185*^9}, {
   3.976298850603284*^9, 3.97629886869273*^9}, {3.976298949761817*^9, 
   3.9762990775834637`*^9}, {3.976299131126025*^9, 3.97629914847344*^9}, {
   3.9762991830592623`*^9, 3.976299200985818*^9}, {3.9762992669543257`*^9, 
   3.976299268480044*^9}, {3.9762993216970987`*^9, 3.9762993504157467`*^9}, 
   3.976299395686453*^9, {3.9762994875826197`*^9, 3.976299543387011*^9}, {
   3.976299588812333*^9, 3.9762996070075483`*^9}, {3.976299677282529*^9, 
   3.976299759251196*^9}, {3.976299856457436*^9, 3.9762998713035927`*^9}, {
   3.976299902680427*^9, 3.976299911911448*^9}, {3.9763001655570517`*^9, 
   3.9763001986757183`*^9}, {3.976300265569654*^9, 3.976300370564855*^9}, {
   3.9763004648186407`*^9, 3.976300594215391*^9}, 3.976302761737484*^9, 
   3.976331380954321*^9},ExpressionUUID->"36219a19-d98f-4192-a78f-\
17a4e3e97888"]
},
WindowSize->{1728, 1051},
WindowMargins->{{0, Automatic}, {Automatic, 0}},
FrontEndVersion->"14.3 for Mac OS X ARM (64-bit) (July 8, 2025)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"0543f059-a012-4b6c-8655-c9482b1d85bf"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[554, 20, 2200, 61, 172, "Input",ExpressionUUID->"12b745ba-6c5a-4023-8ad9-9da76874d8e2"],
Cell[2757, 83, 1883, 48, 192, "Input",ExpressionUUID->"13662720-b09d-43cb-a136-01a86310efc1"],
Cell[4643, 133, 7425, 203, 437, "Input",ExpressionUUID->"fca58653-f31e-4634-847c-0491020d8cbf"],
Cell[12071, 338, 520, 12, 70, "Input",ExpressionUUID->"3b5522d1-65d1-4059-9504-0c75cec02f1c"],
Cell[12594, 352, 3993, 110, 242, "Input",ExpressionUUID->"f100b477-6109-4002-8014-50ed825e8e06"],
Cell[16590, 464, 4628, 128, 335, "Input",ExpressionUUID->"1c785ead-9043-4112-bd3b-1070b8d6ecc3"],
Cell[21221, 594, 15110, 437, 1336, "Input",ExpressionUUID->"92e9fd24-d83c-4c6c-a97e-0a9464d37b30"],
Cell[36334, 1033, 721, 15, 49, "Input",ExpressionUUID->"fc6c9a35-c9f1-4bdb-86a8-2c6d470e1cfb"],
Cell[37058, 1050, 16930, 410, 866, "Input",ExpressionUUID->"bea84773-e3d1-4f98-91bf-65932e4a0942"],
Cell[53991, 1462, 15924, 420, 744, "Input",ExpressionUUID->"4093261b-bb3d-4694-9685-fbed0406f62c"],
Cell[69918, 1884, 19380, 545, 1397, "Input",ExpressionUUID->"36219a19-d98f-4192-a78f-17a4e3e97888"]
}
]
*)

